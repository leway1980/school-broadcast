<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校園廣播系統 - 行政管理後台</title>
    <!-- 引入 Tailwind CSS 框架，用於快速樣式設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 引入 Inter 字體和基本樣式 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; }
        
        /* --- 版面配置 CSS 調整 (Grid Layout) --- */
        /* 主網格佈局，小螢幕下為單欄 */
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 1024px) { 
             /* 關鍵修改: 將版面改為 50/50 比例 (1fr 1fr) */
            .main-grid { grid-template-columns: 1fr 1fr; } 
        }
        
        /* 單位管理清單項目樣式 */
        .unit-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s; }
        .unit-item:hover { background-color: #f9fafb; }
        
        /* 按鈕基本樣式 */
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; transition: background-color 0.2s, transform 0.1s; cursor: pointer; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; transform: translateY(-1px); }
        .btn-secondary { background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
        .btn-secondary:hover { background-color: #e5e7eb; }
    </style>
</head>
<body>
    <div class="container mx-auto p-4 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">校園廣播系統 - 行政管理後台</h1>
        </header>

        <div class="main-grid">
            
            <!-- 廣播發布與編輯區 -->
            <div class="bg-white p-6 rounded-xl shadow-lg h-fit">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6">發布/編輯廣播訊息</h2>
                
                <form id="broadcast-form" class="space-y-4">
                    <!-- 編輯模式下的文件 ID，隱藏 -->
                    <input type="hidden" id="editModeDocId" value="">
                    
                    <!-- 訊息內容 -->
                    <div>
                        <label for="content" class="block text-sm font-medium text-gray-700 mb-1">訊息內容 (必填)</label>
                        <textarea id="content" name="content" rows="4" required
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3 border resize-none"
                            placeholder="輸入廣播訊息內容..."></textarea>
                    </div>

                    <!-- 發布單位 (原版，準備修改) -->
                    <div>
                        <label for="unit" class="block text-sm font-medium text-gray-700">發布單位 (必選)</label>
                        <select id="unit" name="unit" required
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="">選擇發布單位</option>
                            <!-- 選項將由 JavaScript 動態載入 -->
                        </select>
                    </div>
                    
                    <!-- 截止時間 (Duration) -->
                    <div>
                        <span class="block text-sm font-medium text-gray-700 mb-2">廣播效期 (必選)</span>
                        <div class="flex flex-wrap gap-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="duration" value="8" checked class="form-radio h-4 w-4 text-indigo-600">
                                <span class="ml-2 text-gray-700">8 小時</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="duration" value="24" class="form-radio h-4 w-4 text-indigo-600">
                                <span class="ml-2 text-gray-700">24 小時</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="duration" value="48" class="form-radio h-4 w-4 text-indigo-600">
                                <span class="ml-2 text-gray-700">48 小時</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="duration" value="custom" class="form-radio h-4 w-4 text-indigo-600">
                                <span class="ml-2 text-gray-700">自訂日期</span>
                            </label>
                        </div>
                        <input type="datetime-local" id="custom-expiresAt" class="mt-2 p-2 border rounded-md hidden w-full">
                    </div>

                    <!-- 廣播類型 (Categories) -->
                    <div>
                        <span class="block text-sm font-medium text-gray-700 mb-2">廣播類型 (可多選)</span>
                        <div id="category-checkboxes" class="flex flex-wrap gap-4">
                            <!-- 勾選框將由 JavaScript 動態載入 -->
                        </div>
                    </div>

                    <div class="flex gap-4 pt-4">
                        <button type="submit" id="submitBtn" class="btn btn-primary w-full">發布廣播</button>
                        <button type="button" id="cancelEditBtn" class="btn btn-secondary hidden w-1/3">取消編輯</button>
                    </div>
                </form>
            </div>

            <!-- 單位管理與廣播列表區 -->
            <div class="space-y-8">
                <!-- 單位管理 -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">單位/類型管理</h2>
                    <form id="unit-form" class="flex gap-2 mb-4">
                        <input type="text" id="newUnit" placeholder="新增發布單位名稱" required class="flex-grow p-2 border rounded-md text-sm">
                        <button type="submit" class="btn btn-secondary px-4 py-2">新增單位</button>
                    </form>
                    <div id="unit-list" class="max-h-40 overflow-y-auto border rounded-md">
                        <!-- 單位列表將由 JavaScript 動態載入 -->
                    </div>
                    
                    <form id="category-form" class="flex gap-2 mt-6 mb-4">
                        <input type="text" id="newCategory" placeholder="新增廣播類型名稱" required class="flex-grow p-2 border rounded-md text-sm">
                        <button type="submit" class="btn btn-secondary px-4 py-2">新增類型</button>
                    </form>
                    <div id="category-list" class="max-h-40 overflow-y-auto border rounded-md">
                        <!-- 類型列表將由 JavaScript 動態載入 -->
                    </div>
                </div>

                <!-- 廣播列表 -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">已發布廣播列表 (未過期)</h2>
                    <div id="message-list" class="space-y-4">
                        <p id="loading-msg" class="text-gray-500 text-center">載入中...</p>
                        <!-- 廣播列表將由 JavaScript 動態載入 -->
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, collection, 
            addDoc, setDoc, updateDoc, deleteDoc, 
            onSnapshot, query, where, orderBy, limit,
            serverTimestamp, getDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 全域變數初始化 (由 Canvas 提供) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase 初始化 ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;
        
        // 確保登入 (使用 Custom Token 或匿名登入)
        async function authenticate() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || 'anonymous';
                console.log("Firebase Auth Success. User ID:", userId);
                
                // 認證成功後才開始監聽資料
                setupRealtimeListeners();
            } catch (error) {
                console.error("Firebase 認證失敗:", error);
            }
        }
        
        // --- DOM 元素引用 ---
        const broadcastForm = document.getElementById('broadcast-form');
        const contentInput = document.getElementById('content');
        const unitSelect = document.getElementById('unit');
        const customExpiresAtInput = document.getElementById('custom-expiresAt');
        const categoryCheckboxesDiv = document.getElementById('category-checkboxes');
        const submitBtn = document.getElementById('submitBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const editModeDocId = document.getElementById('editModeDocId');
        const messageList = document.getElementById('message-list');
        const loadingMsg = document.getElementById('loading-msg');
        
        // --- 輔助函式 ---
        const getUnitCollectionRef = () => collection(db, 'artifacts', appId, 'users', userId, 'units');
        const getCategoryCollectionRef = () => collection(db, 'artifacts', appId, 'users', userId, 'categories');
        const getMessageCollectionRef = () => collection(db, 'messages'); // 公共廣播訊息
        
        // 將秒數轉換為 'YYYY/MM/DD HH:mm:ss' 格式
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const h = String(date.getHours()).padStart(2, '0');
            const min = String(date.getMinutes()).padStart(2, '0');
            const s = String(date.getSeconds()).padStart(2, '0');
            return `${y}/${m}/${d} ${h}:${min}:${s}`;
        }

        // --- 單位 (Unit) 相關函式 ---
        function renderUnitOptions(units) {
            // 清空舊選項，但保留第一個預設選項
            unitSelect.innerHTML = '<option value="">選擇發布單位</option>'; 
            units.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.name;
                option.textContent = unit.name;
                unitSelect.appendChild(option);
            });
            // 【未來要加載最近單位邏輯在這裡】
        }

        function renderUnitList(units) {
            const unitListDiv = document.getElementById('unit-list');
            unitListDiv.innerHTML = '';
            units.forEach(unit => {
                const item = document.createElement('div');
                item.className = 'unit-item';
                item.innerHTML = `
                    <span class="text-sm text-gray-800">${unit.name}</span>
                    <button type="button" class="text-red-500 hover:text-red-700 text-xs" onclick="deleteUnit('${unit.id}')">刪除</button>
                `;
                unitListDiv.appendChild(item);
            });
        }
        
        // 新增單位
        document.getElementById('unit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('newUnit').value.trim();
            if (name) {
                try {
                    await addDoc(getUnitCollectionRef(), { name: name, createdAt: serverTimestamp() });
                    document.getElementById('newUnit').value = '';
                } catch (error) {
                    console.error("新增單位失敗:", error);
                }
            }
        });

        // 刪除單位
        window.deleteUnit = async (id) => {
            if (confirm('確定要刪除此單位嗎？')) { // 使用內建 confirm 替代 alert
                try {
                    await deleteDoc(doc(getUnitCollectionRef(), id));
                } catch (error) {
                    console.error("刪除單位失敗:", error);
                }
            }
        };

        // --- 類型 (Category) 相關函式 ---
        function renderCategoryCheckboxes(categories) {
            categoryCheckboxesDiv.innerHTML = '';
            categories.forEach(category => {
                const label = document.createElement('label');
                label.className = 'inline-flex items-center';
                label.innerHTML = `
                    <input type="checkbox" name="categories" value="${category.name}" class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                    <span class="ml-2 text-gray-700">${category.name}</span>
                `;
                categoryCheckboxesDiv.appendChild(label);
            });
        }
        
        function renderCategoryList(categories) {
            const categoryListDiv = document.getElementById('category-list');
            categoryListDiv.innerHTML = '';
            categories.forEach(category => {
                const item = document.createElement('div');
                item.className = 'unit-item';
                item.innerHTML = `
                    <span class="text-sm text-gray-800">${category.name}</span>
                    <button type="button" class="text-red-500 hover:text-red-700 text-xs" onclick="deleteCategory('${category.id}')">刪除</button>
                `;
                categoryListDiv.appendChild(item);
            });
        }
        
        // 新增類型
        document.getElementById('category-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('newCategory').value.trim();
            if (name) {
                try {
                    await addDoc(getCategoryCollectionRef(), { name: name, createdAt: serverTimestamp() });
                    document.getElementById('newCategory').value = '';
                } catch (error) {
                    console.error("新增類型失敗:", error);
                }
            }
        });

        // 刪除類型
        window.deleteCategory = async (id) => {
            if (confirm('確定要刪除此類型嗎？')) { // 使用內建 confirm 替代 alert
                try {
                    await deleteDoc(doc(getCategoryCollectionRef(), id));
                } catch (error) {
                    console.error("刪除類型失敗:", error);
                }
            }
        };

        // --- 廣播訊息 (Message) 相關函式 ---
        function renderMessages(messages) {
            loadingMsg.classList.add('hidden');
            messageList.innerHTML = '';
            if (messages.length === 0) {
                messageList.innerHTML = '<p class="text-gray-500">目前沒有未過期的廣播訊息。</p>';
                return;
            }
            
            messages.forEach(msg => {
                const item = document.createElement('div');
                item.className = 'border p-4 rounded-lg bg-gray-50';
                
                const unitText = `<span class="bg-indigo-100 text-indigo-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">${msg.unit}</span>`;
                const categories = (msg.categories || []).map(c => 
                    `<span class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">${c}</span>`
                ).join('');
                
                item.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            ${unitText}
                            ${categories}
                        </div>
                        <div class="flex space-x-2">
                            <button type="button" class="text-blue-500 hover:text-blue-700 text-sm" onclick="handleEdit('${msg.id}')">編輯</button>
                            <button type="button" class="text-red-500 hover:text-red-700 text-sm" onclick="handleDelete('${msg.id}')">刪除 (立即過期)</button>
                        </div>
                    </div>
                    <p class="text-gray-900 mb-2 whitespace-pre-wrap">${msg.content}</p>
                    <p class="text-xs text-gray-500">發布時間: ${formatTimestamp(msg.createdAt)}</p>
                    <p class="text-xs text-red-500">截止時間: ${formatTimestamp(msg.expiresAt)}</p>
                `;
                messageList.appendChild(item);
            });
        }
        
        // 處理編輯按鈕點擊事件
        window.handleEdit = async (id) => {
            const docRef = doc(db, "messages", id);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                editModeDocId.value = id;
                submitBtn.textContent = '更新廣播';
                contentInput.value = data.content;
                unitSelect.value = data.unit;

                // 設置類型
                document.querySelectorAll('input[name="categories"]').forEach(cb => {
                    cb.checked = (data.categories || []).includes(cb.value);
                });

                // 設置截止時間
                const now = new Date();
                const expiresAt = data.expiresAt.toDate();
                const diffMs = expiresAt.getTime() - now.getTime();
                const diffHours = diffMs / (1000 * 60 * 60);

                let durationValue = '8'; 
                if (Math.abs(diffHours - 24) < 1) durationValue = '24'; 
                else if (Math.abs(diffHours - 48) < 1) durationValue = '48'; 
                
                const durationInput = document.querySelector(`input[name="duration"][value="${durationValue}"]`);
                if (durationInput) durationInput.checked = true;

                cancelEditBtn.classList.remove('hidden');
                window.scrollTo(0, 0); // 滾動到頂部方便編輯
            }
        }
        
        // 處理刪除按鈕點擊事件 (將 expiresAt 設為當前時間，使其立即過期)
        window.handleDelete = async (id) => {
            if (confirm('確定要刪除此廣播嗎？這將使其立即過期。')) {
                await updateDoc(doc(db, "messages", id), { expiresAt: new Date() });
                console.log("訊息已標記為過期，將自動從列表中消失。");
            }
        }
        
        // 重設表單狀態
        function resetForm() {
            document.getElementById('broadcast-form').reset();
            // 重設所有勾選框狀態
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            // 預設選擇 8 小時
            document.querySelector('input[name="duration"][value="8"]').checked = true; 
            editModeDocId.value = '';
            cancelEditBtn.classList.add('hidden');
            submitBtn.textContent = '發布廣播';
            customExpiresAtInput.classList.add('hidden');
            customExpiresAtInput.value = '';
            
            // 重設單位選擇為預設
            // 【未來要加載最近單位邏輯在這裡】
        }

        // --- 提交邏輯 ---
        broadcastForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const content = contentInput.value.trim();
            const unit = unitSelect.value;
            const docId = editModeDocId.value;
            
            if (!content || !unit) {
                alert('訊息內容和發布單位皆為必填。');
                return;
            }

            // 獲取選定的類型
            const selectedCategories = Array.from(document.querySelectorAll('input[name="categories"]:checked'))
                                            .map(cb => cb.value);

            // 計算截止時間
            let expiresAt;
            const durationRadio = document.querySelector('input[name="duration"]:checked');
            const durationValue = durationRadio ? durationRadio.value : '8';
            
            const now = new Date();
            if (durationValue === 'custom') {
                const customDate = customExpiresAtInput.value;
                if (!customDate) {
                    alert('請選擇自訂截止日期時間。');
                    return;
                }
                expiresAt = new Date(customDate);
            } else {
                const hours = parseInt(durationValue, 10);
                expiresAt = new Date(now.getTime() + hours * 60 * 60 * 1000);
            }

            // 準備資料物件
            const data = {
                content: content,
                unit: unit,
                categories: selectedCategories,
                expiresAt: expiresAt,
            };
            
            // 執行新增或更新
            try {
                if (docId) {
                    // 更新現有文件
                    await updateDoc(doc(db, "messages", docId), data);
                    console.log("廣播訊息已更新，ID:", docId);
                } else {
                    // 新增文件
                    await addDoc(getMessageCollectionRef(), { ...data, createdAt: serverTimestamp() });
                    console.log("新廣播訊息已發布。");
                }
                resetForm(); // 重設表單
            } catch (error) {
                console.error("發布/更新失敗:", error);
                alert("發布/更新廣播訊息失敗：" + error.message);
            }
        });

        // 監聽自訂日期選項
        document.querySelectorAll('input[name="duration"]').forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'custom') {
                    customExpiresAtInput.classList.remove('hidden');
                    // 預設設定為 24 小時後
                    const tomorrow = new Date(new Date().getTime() + 24 * 60 * 60 * 1000);
                    customExpiresAtInput.value = tomorrow.toISOString().slice(0, 16);
                } else {
                    customExpiresAtInput.classList.add('hidden');
                    customExpiresAtInput.value = '';
                }
            });
        });
        
        // --- 即時監聽設定 ---
        function setupRealtimeListeners() {
            // 監聽單位列表
            onSnapshot(query(getUnitCollectionRef(), orderBy('createdAt', 'asc')), (snapshot) => {
                const units = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUnitOptions(units);
            }, (error) => {
                console.error("監聽單位列表失敗:", error);
            });
            // ... (其他監聽器)
        }
        
        // 啟動應用
        authenticate();
        resetForm(); // 首次載入時呼叫以設置預設狀態
    </script>
</body>
</html>
