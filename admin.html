<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校園廣播系統 - 行政管理後台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; }
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 1024px) { .main-grid { grid-template-columns: 400px 1fr; } }
        /* 移除 .class-grid，改用新的 .grade-row 樣式 */
        .unit-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-radius: 0.25rem; }
        .unit-item:hover { background-color: #e9ecef; }
        .unit-item input { border: none; background: transparent; }
        .unit-item button { color: #dc3545; }
        .grade-row { border-bottom: 1px dashed #e5e7eb; padding: 8px 0; }
        .grade-row:last-child { border-bottom: none; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- 登入畫面 -->
    <div id="login-container" class="text-center p-8 bg-white rounded-lg shadow-xl max-w-md w-full">
        <h1 class="text-2xl font-bold mb-4">校園廣播系統</h1>
        <p class="text-gray-600 mb-6">請使用學校 G Suite 帳號登入</p>
        <button id="login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center mx-auto">
            <svg class="w-6 h-6 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.82l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
            使用 Google 帳號登入
        </button>
    </div>

    <!-- 主操作畫面 -->
    <div id="main-container" class="w-full max-w-7xl p-8 bg-white rounded-lg shadow-xl hidden">
        <div class="flex justify-between items-center mb-6 pb-4 border-b">
            <div>
                <h1 class="text-3xl font-bold">行政管理後台</h1>
                <p id="user-info" class="text-sm text-gray-500"></p>
            </div>
            <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">登出</button>
        </div>

        <div id="permission-denied" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
            <p class="font-bold">權限不足</p><p>您的帳號不在管理員名單中，無法執行此操作。</p>
        </div>

        <div id="app-content" class="main-grid">
            <!-- Left Column: Form -->
            <form id="broadcast-form" class="space-y-6">
                <input type="hidden" id="edit-mode-doc-id">
                <!-- Unit & Duration -->
                <div class="flex gap-4">
                    <div class="flex-grow">
                        <label for="unit-select" class="block text-sm font-medium text-gray-700">發布單位</label>
                        <select id="unit-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md">
                            <option value="" disabled selected>請選擇單位</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">持續時間</label>
                        <div class="mt-1 flex space-x-2">
                             <!-- 修正：確保 8小時 預設被選中 -->
                             <input type="radio" id="dur_8h" name="duration" value="8" class="hidden peer" checked><label for="dur_8h" class="px-3 py-1 border rounded-md cursor-pointer peer-checked:bg-blue-500 peer-checked:text-white">8小時</label>
                             <input type="radio" id="dur_1d" name="duration" value="24" class="hidden peer"><label for="dur_1d" class="px-3 py-1 border rounded-md cursor-pointer peer-checked:bg-blue-500 peer-checked:text-white">1天</label>
                             <input type="radio" id="dur_2d" name="duration" value="48" class="hidden peer"><label for="dur_2d" class="px-3 py-1 border rounded-md cursor-pointer peer-checked:bg-blue-500 peer-checked:text-white">2天</label>
                        </div>
                    </div>
                </div>
                <!-- Unit Management -->
                <details id="unit-management">
                    <summary class="cursor-pointer text-blue-600 hover:underline">管理發布單位 ▾</summary>
                    <div id="unit-list" class="mt-2 p-4 border rounded-md space-y-2"></div>
                    <button type="button" id="add-unit-btn" class="mt-2 text-sm text-green-600">✚ 新增單位</button>
                    <!-- 修正：將按鈕名稱改得更清楚，按下 Enter 或此按鈕都會儲存變更 -->
                    <button type="button" id="save-units-btn" class="mt-2 text-sm text-white bg-blue-500 px-3 py-1 rounded">儲存所有變更</button>
                </details>
                <!-- Target Audience -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">廣播對象</label>
                    <!-- 班級清單已更新為簡短顯示模式 -->
                    <div id="class-checkbox-container" class="mt-2 p-4 border rounded-md max-h-60 overflow-y-auto space-y-1"></div>
                </div>
                <!-- Content -->
                <div>
                    <label for="message-content" class="block text-sm font-medium text-gray-700">訊息內容</label>
                    <textarea id="message-content" rows="5" class="mt-1 shadow-sm block w-full sm:text-sm border border-gray-300 rounded-md"></textarea>
                </div>
                 <!-- Emergency -->
                <div class="flex items-center">
                    <input id="is-emergency" type="checkbox" class="h-4 w-4 text-red-600 border-gray-300 rounded">
                    <label for="is-emergency" class="ml-2 block text-sm text-gray-900">設為緊急訊息</label>
                </div>
                <!-- Submit -->
                <div class="flex gap-4">
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">發布/更新公告</button>
                    <button type="button" id="cancel-edit-btn" class="w-1/3 flex justify-center py-2 px-4 border rounded-md text-sm font-medium bg-gray-200 hover:bg-gray-300 hidden">取消編輯</button>
                </div>
            </form>

            <!-- Right Column: Message List -->
            <div id="message-list-container" class="border-l pl-6">
                 <h2 class="text-xl font-bold mb-4">即時訊息列表 (未過期)</h2>
                 <div id="message-list" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp, getDocs, orderBy, query, writeBatch, deleteDoc, updateDoc, onSnapshot, where, setLogLevel } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // 設定 Firebase log level for debugging
        setLogLevel('debug');
        
        const firebaseConfig = {
            apiKey: "AIzaSyDQCFgkOKJcz6dKP7gZMEjCYBJd3xnJ3bA",
            authDomain: "school-broadcast-system.firebaseapp.com",
            projectId: "school-broadcast-system",
            storageBucket: "school-broadcast-system.appspot.com",
            messagingSenderId: "1057938447303",
            appId: "1:1057938447303:web:81042cfb29f24bc4ff97e2",
            measurementId: "G-LLRPYTW9QX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ 'hd': 'tcsh.hlc.edu.tw' });
        
        // DOM Elements
        const loginContainer = document.getElementById('login-container');
        const mainContainer = document.getElementById('main-container');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const broadcastForm = document.getElementById('broadcast-form');
        const permissionDenied = document.getElementById('permission-denied');
        const appContent = document.getElementById('app-content');
        const unitSelect = document.getElementById('unit-select');
        const unitList = document.getElementById('unit-list');
        const addUnitBtn = document.getElementById('add-unit-btn');
        const saveUnitsBtn = document.getElementById('save-units-btn');
        const classCheckboxContainer = document.getElementById('class-checkbox-container');
        const messageList = document.getElementById('message-list');
        const editModeDocId = document.getElementById('edit-mode-doc-id');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        
        let unitData = []; // Store original unit data {id, name}

        // Auth State
        onAuthStateChanged(auth, user => {
            if (user && user.email.endsWith('@tcsh.hlc.edu.tw')) {
                loginContainer.classList.add('hidden');
                mainContainer.classList.remove('hidden');
                userInfo.textContent = `管理員：${user.displayName} (${user.email})`;
                checkAdminPermission(user.email);
            } else {
                mainContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
            }
        });

        async function checkAdminPermission(email) {
            const docRef = doc(db, "admins", email);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                appContent.classList.remove('hidden');
                permissionDenied.classList.add('hidden');
                loadInitialData();
            } else {
                appContent.classList.add('hidden');
                permissionDenied.classList.remove('hidden');
            }
        }
        
        // Data Loading and Rendering
        function loadInitialData() {
            // Real-time listeners for Units
            onSnapshot(collection(db, "units"), (snapshot) => {
                unitData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUnits();
            }, (error) => {
                console.error("Error fetching units:", error);
            });
            
            // Real-time listeners for Class Map (班級對應表)
            // 修正 Firebase 查詢語法，解決讀取班級對應表的問題
            const classQuery = query(collection(db, "class_map"), orderBy("classId"));
            onSnapshot(classQuery, (snapshot) => {
                console.log("Class Map Snapshot received. Docs count:", snapshot.docs.length); // 輸出 log 協助檢查是否有讀到資料
                renderClassCheckboxes(snapshot.docs.map(doc => doc.data()));
            }, (error) => {
                console.error("Error fetching class map:", error); // 輸出錯誤 log
            });

            // Real-time listeners for Messages (即時訊息列表)
            const q = query(collection(db, "messages"), where("expiresAt", ">", new Date()), orderBy("expiresAt", "desc"));
            onSnapshot(q, (snapshot) => {
                renderMessages(snapshot.docs);
            }, (error) => {
                console.error("Error fetching messages:", error);
            });
        }
        
        function renderUnits() {
            unitSelect.innerHTML = '<option value="" disabled selected>請選擇單位</option>'; // 確保預設選項是 "請選擇單位"
            unitList.innerHTML = '';
            unitData.forEach(({ id, name }) => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                unitSelect.appendChild(option);

                const item = document.createElement('div');
                item.className = 'unit-item';
                item.innerHTML = `<input type="text" value="${name}" data-id="${id}" class="flex-grow"><button data-id="${id}" class="remove-unit-btn">✖</button>`;
                unitList.appendChild(item);
            });
            document.querySelectorAll('.remove-unit-btn').forEach(btn => btn.addEventListener('click', () => btn.parentElement.remove()));
        }
        
        function renderClassCheckboxes(classes) {
             classCheckboxContainer.innerHTML = '';
             const grades = {};
             
             // 1. Add All-School option first
             const allDiv = document.createElement('div');
             allDiv.className = 'grade-row flex items-center bg-gray-50 p-2 rounded-t-md';
             allDiv.innerHTML = `<div class="flex items-center font-bold w-full"><input id="class-All" name="targetClasses" value="All" type="checkbox" class="h-4 w-4 text-indigo-600"><label for="class-All" class="ml-2">全校廣播</label></div>`;
             classCheckboxContainer.appendChild(allDiv);
             
             // 如果沒有讀到班級資料，顯示提示
             if (classes.length === 0) {
                 const tip = document.createElement('p');
                 tip.className = 'text-center text-gray-400 mt-4';
                 tip.textContent = '未讀取到班級對應表資料，請確認 class_map collection 是否有資料。';
                 classCheckboxContainer.appendChild(tip);
                 return;
             }

             // 2. Group classes by grade
             classes.forEach(c => {
                 // 假設 class name 格式為 "國一-知足"
                 const parts = c.name.split('-');
                 const grade = parts[0]; // 例如 "國一"
                 // 如果沒有 '-'，則使用完整名稱作為班級名稱，並將 grade 設為 "其他"
                 const className = parts.length > 1 ? parts[1] : c.name; 
                 
                 // 如果班級名稱解析出來是空的，跳過
                 if (!className.trim()) return;

                 if (!grades[grade]) grades[grade] = { classes: [], names: [] };
                 grades[grade].classes.push({ id: c.classId, name: className });
                 grades[grade].names.push(className);
             });

             // 3. Render each grade row
             for (const grade in grades) {
                const gradeInfo = grades[grade];
                
                const gradeDiv = document.createElement('div');
                gradeDiv.className = "grade-row flex items-center p-2 hover:bg-gray-100";
                
                // Class Checkboxes (Actual functional inputs - hidden)
                const hiddenInputsHTML = gradeInfo.classes.map(c => 
                     `<input id="class-${c.id}" name="targetClasses" value="${c.id}" type="checkbox" class="class-checkbox-${grade} hidden">`
                ).join('');
                
                // Display and Grade Checkbox
                gradeDiv.innerHTML = `
                    <div class="flex items-center">
                        <input id="grade-${grade}" type="checkbox" class="h-4 w-4 text-indigo-600 grade-checkbox" data-grade="${grade}">
                        <label for="grade-${grade}" class="ml-2 font-semibold text-gray-700 w-12">${grade}</label>
                    </div>
                    <!-- 簡短顯示班級名稱 (所有班級名稱以空格分隔) -->
                    <div class="flex-1 text-sm text-gray-600 ml-4 space-x-2">
                        ${gradeInfo.names.map(name => `<span class="whitespace-nowrap">${name}</span>`).join(' ')}
                    </div>
                    <div class="hidden-class-inputs">${hiddenInputsHTML}</div>
                `;
                classCheckboxContainer.appendChild(gradeDiv);
             }
             
             // Add event listeners for grade-level checkboxes
             document.querySelectorAll('.grade-checkbox').forEach(cb => {
                 cb.addEventListener('change', (e) => {
                     const grade = e.target.dataset.grade;
                     // 找到所有屬於該年級的隱藏 class checkbox，並同步勾選狀態
                     document.querySelectorAll(`.class-checkbox-${grade}`).forEach(classCb => classCb.checked = e.target.checked);
                 });
             });
        }

        function renderMessages(docs) {
            messageList.innerHTML = '';
            if (docs.length === 0) {
                 messageList.innerHTML = `<p class="text-gray-500 text-center">沒有未過期的訊息。</p>`;
            }
            docs.forEach(doc => {
                const msg = { id: doc.id, ...doc.data() };
                const card = document.createElement('div');
                card.className = `p-4 border rounded-md ${msg.isEmergency ? 'bg-red-50 border-red-200' : 'bg-gray-50'}`;
                
                // 檢查 expiresAt 是否為 Firebase Timestamp，並轉換為 Date
                let expiresDate = msg.expiresAt instanceof Date ? msg.expiresAt : msg.expiresAt.toDate();
                let timeLeft = Math.round((expiresDate - new Date()) / (1000 * 60 * 60));
                
                // 避免顯示負數時間 (如果列表更新速度慢於過期時間)
                if (timeLeft < 0) timeLeft = 0; 
                
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold">${msg.unit}</p>
                            <p class="text-sm mt-1">${msg.content}</p>
                        </div>
                        <div class="flex gap-2">
                             <button class="edit-btn text-sm text-blue-500" data-id="${msg.id}">編輯</button>
                             <button class="delete-btn text-sm text-red-500" data-id="${msg.id}">刪除</button>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-2 pt-2 border-t">
                        發布給: ${msg.targetClasses.join(', ')} | ${msg.isEmergency ? '<span class="font-bold text-red-600">緊急</span> |' : ''} 剩餘: ${timeLeft} 小時
                    </div>
                `;
                messageList.appendChild(card);
            });
            
            document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', () => handleEdit(btn.dataset.id)));
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', () => handleDelete(btn.dataset.id)));
        }
        
        // Event Handlers
        loginBtn.addEventListener('click', () => signInWithPopup(auth, provider));
        logoutBtn.addEventListener('click', () => signOut(auth));

        addUnitBtn.addEventListener('click', () => {
            const item = document.createElement('div');
            item.className = 'unit-item';
            // 將 data-id 設為臨時值，方便後續處理
            item.innerHTML = `<input type="text" placeholder="新單位名稱" data-id="" class="flex-grow unit-input"><button class="remove-unit-btn">✖</button>`; 
            unitList.appendChild(item);
            item.querySelector('button').addEventListener('click', () => item.remove());
            item.querySelector('input').focus(); // 自動聚焦到新欄位
        });
        
        // 修正：新增 Enter 鍵事件監聽，讓使用者在輸入單位後按 Enter 即可儲存
        unitList.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
                e.preventDefault(); // 防止默認的表單提交
                saveUnitsBtn.click();
            }
        });

        saveUnitsBtn.addEventListener('click', async () => {
            const batch = writeBatch(db);
            const newUnitElements = unitList.querySelectorAll('input');
            const currentUnitNames = new Set();
            let hasError = false;

            // 1. 處理新增和修改
            newUnitElements.forEach(input => {
                const name = input.value.trim();
                if (!name) { console.error("單位名稱不可為空！"); hasError = true; return; }
                if (currentUnitNames.has(name)) { console.error(`單位名稱 "${name}" 重複！`); hasError = true; return; }
                currentUnitNames.add(name);
                
                const id = input.dataset.id;
                if (id) { // Update existing
                    batch.update(doc(db, "units", id), { name });
                } else { // Add new
                    // 為了確保 ID 不重複，這裡使用 setDoc 而非 addDoc，讓 Firestore 自動生成 ID
                    batch.set(doc(collection(db, "units")), { name });
                    input.dataset.id = 'new-temp'; // 標記為已處理，但實際 ID 會在 onSnapshot 後更新
                }
            });

            if (hasError) return;

            // 2. 處理刪除 (與原始清單比較)
            const originalNames = new Set(unitData.map(u => u.name));
            originalNames.forEach(name => {
                if (!currentUnitNames.has(name)) {
                    const unitToDelete = unitData.find(u => u.name === name);
                    if (unitToDelete) batch.delete(doc(db, "units", unitToDelete.id));
                }
            });
            
            try {
                await batch.commit();
                console.log("單位列表更新成功！"); 
                // document.getElementById('unit-management').open = false; // 保持開啟讓使用者看到結果
            } catch (e) { 
                console.error("單位列表更新失敗：", e);
            }
        });

        broadcastForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const unit = broadcastForm.querySelector('#unit-select').value;
            const content = broadcastForm.querySelector('#message-content').value;
            const isEmergency = broadcastForm.querySelector('#is-emergency').checked;
            const durationHours = parseInt(broadcastForm.querySelector('input[name="duration"]:checked').value);
            // 抓取所有 name="targetClasses" 且被勾選的輸入欄位
            const selectedClasses = Array.from(document.querySelectorAll('input[name="targetClasses"]:checked')).map(cb => cb.value);

            if (!unit || !content.trim() || selectedClasses.length === 0) {
                console.error('發布單位、訊息內容和廣播對象皆不可為空！'); return;
            }

            const messageData = {
                unit, content, isEmergency,
                targetClasses: selectedClasses,
                author: { name: auth.currentUser.displayName, email: auth.currentUser.email },
                createdAt: serverTimestamp(),
                expiresAt: new Date(Date.now() + durationHours * 60 * 60 * 1000)
            };
            
            try {
                const docId = editModeDocId.value;
                if (docId) { // Edit mode
                    await updateDoc(doc(db, "messages", docId), messageData);
                    console.log('公告更新成功！');
                } else { // Create mode
                    await addDoc(collection(db, "messages"), messageData);
                    console.log('公告發布成功！');
                }
                resetForm();
            } catch (error) { 
                console.error(`操作失敗: ${error.message}`); 
            }
        });

        cancelEditBtn.addEventListener('click', resetForm);
        
        async function handleEdit(id) {
            const docRef = doc(db, "messages", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const msg = docSnap.data();
                editModeDocId.value = id;
                document.querySelector('#unit-select').value = msg.unit;
                document.querySelector('#message-content').value = msg.content;
                document.querySelector('#is-emergency').checked = msg.isEmergency;
                
                // 1. 重設所有班級和年級的勾選狀態
                document.querySelectorAll('input[name="targetClasses"]').forEach(cb => cb.checked = false);
                document.querySelectorAll('.grade-checkbox').forEach(cb => cb.checked = false);

                // 2. 勾選目標班級
                msg.targetClasses.forEach(classId => {
                    const cb = document.querySelector(`input[value="${classId}"]`);
                    if(cb) {
                        cb.checked = true;
                    }
                });
                
                // 3. 檢查並勾選年級總體選項 (如果該年級所有班級都被勾選)
                document.querySelectorAll('.grade-checkbox').forEach(gradeCb => {
                    const grade = gradeCb.dataset.grade;
                    const classCbs = document.querySelectorAll(`.class-checkbox-${grade}`);
                    const totalClasses = classCbs.length;
                    const checkedClasses = Array.from(classCbs).filter(cb => cb.checked).length;
                    if (totalClasses > 0 && totalClasses === checkedClasses) {
                        gradeCb.checked = true;
                    }
                });

                // 4. 設定持續時間 (基於過期時間和當前時間的差值來推算原始設定)
                let expiresDate = msg.expiresAt instanceof Date ? msg.expiresAt : msg.expiresAt.toDate();
                const diffMs = expiresDate.getTime() - msg.createdAt.toDate().getTime();
                const diffHours = Math.round(diffMs / (1000 * 60 * 60));
                
                let durationValue = '8'; // 預設 8 小時
                if (Math.abs(diffHours - 24) < 1) durationValue = '24';
                else if (Math.abs(diffHours - 48) < 1) durationValue = '48';
                
                const durationInput = document.querySelector(`input[name="duration"][value="${durationValue}"]`);
                if (durationInput) durationInput.checked = true;


                cancelEditBtn.classList.remove('hidden');
                window.scrollTo(0, 0);
            }
        }
        
        async function handleDelete(id) {
            // 修正：移除 confirm()，直接執行刪除操作（將 expiresAt 設為當前時間）
            // onSnapshot 會自動偵測到過期並從列表中移除，因此訊息會自動消失。
            await updateDoc(doc(db, "messages", id), { expiresAt: new Date() });
            console.log("訊息已標記為過期。列表將由即時監聽器自動更新。");
        }
        
        function resetForm() {
            broadcastForm.reset();
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            // 確保重設後 8 小時預設被選中
            document.querySelector('input[name="duration"][value="8"]').checked = true; 
            editModeDocId.value = '';
            cancelEditBtn.classList.add('hidden');
        }

    </script>
</body>
</html>
