<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校園廣播系統 - 管理後台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-green': '#013220', // 黑板墨綠色
                        'chalk-yellow': '#f1c40f', // 粉筆黃
                        'chalk-white': '#ecf1f1', // 粉筆白
                        'gray-border': '#7f8c8d'  // 分隔線灰色
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f4f4f5; /* 淺灰色背景 */
            font-family: 'Noto Sans TC', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .form-group label {
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: block;
        }
        .input-style {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            width: 100%;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .input-style:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.25);
        }
        .unit-button {
            transition: background-color 0.15s;
        }
        /* 美化 checkbox 區域 */
        #target-classes-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            border-radius: 0.375rem;
        }
        #target-classes-container label {
            cursor: pointer;
            margin-right: 1rem;
            display: inline-flex;
            align-items: center;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- 載入畫面 (Loading Overlay) -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="flex flex-col items-center">
            <div class="spinner mb-4"></div>
            <p class="text-lg font-semibold text-gray-700">載入中，請稍候...</p>
        </div>
    </div>

    <div id="app-content" class="container mx-auto max-w-4xl hidden">
        <h1 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-2">校園廣播系統 - 管理後台</h1>

        <!-- 廣播表單區域 -->
        <div class="card p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-primary-green" id="form-title">新增廣播訊息</h2>
            <form id="broadcast-form" class="space-y-4">
                
                <input type="hidden" id="edit-mode-doc-id" value="">

                <!-- 訊息發佈單位 -->
                <div class="form-group">
                    <label for="unit-select">發佈單位</label>
                    <select id="unit-select" class="input-style" required>
                        <option value="教務處">教務處</option>
                        <option value="學務處">學務處</option>
                        <option value="總務處">總務處</option>
                        <option value="輔導處">輔導處</option>
                        <option value="圖書館">圖書館</option>
                        <option value="資訊中心">資訊中心</option>
                        <option value="教師">教師</option>
                        <option value="其他">其他</option>
                    </select>
                </div>

                <!-- 訊息內容 -->
                <div class="form-group">
                    <label for="message-content">訊息內容</label>
                    <textarea id="message-content" rows="4" class="input-style" placeholder="請輸入廣播訊息內容..." required></textarea>
                </div>

                <!-- 緊急訊息標記 -->
                <div class="form-group flex items-center">
                    <input type="checkbox" id="is-emergency" class="h-4 w-4 text-red-600 border-gray-300 rounded mr-2">
                    <label for="is-emergency" class="mb-0 text-red-600 font-bold">緊急訊息 (紅字提醒)</label>
                </div>

                <!-- 廣播對象 (班級列表) -->
                <div class="form-group">
                    <label>廣播對象 (可複選)</label>
                    <div id="target-classes-container" class="bg-gray-50 grid grid-cols-2 sm:grid-cols-3 gap-2">
                        <!-- 班級列表將由 JavaScript 載入 -->
                        <div id="classes-loading-placeholder" class="col-span-3 text-center text-gray-500 py-4">
                            載入班級列表中...
                        </div>
                    </div>
                </div>

                <!-- 持續時間 -->
                <div class="form-group">
                    <label>持續時間 (小時)</label>
                    <div class="flex flex-wrap gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="duration" value="2" class="h-4 w-4 text-indigo-600" checked>
                            <span class="ml-2">2小時</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="duration" value="4" class="h-4 w-4 text-indigo-600">
                            <span class="ml-2">4小時</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="duration" value="8" class="h-4 w-4 text-indigo-600" checked>
                            <span class="ml-2">8小時 (預設)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="duration" value="24" class="h-4 w-4 text-indigo-600">
                            <span class="ml-2">24小時</span>
                        </label>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="w-full bg-primary-green hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                        發佈廣播
                    </button>
                    <button type="button" id="cancel-edit-btn" class="hidden bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition duration-200" onclick="resetForm()">
                        取消編輯
                    </button>
                </div>
            </form>
        </div>

        <!-- 訊息列表區域 -->
        <div class="card p-6">
            <h2 class="text-2xl font-semibold mb-4 text-primary-green">當前廣播訊息列表</h2>
            <div id="messages-list" class="space-y-4">
                <p class="text-center text-gray-500" id="list-status">載入中...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設定 Firebase 錯誤級別
        setLogLevel('debug');

        // --- Firebase 初始化和全域變數 ---
        let db;
        let auth;
        let userId = 'anonymous'; // 預設值

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const loadingOverlay = document.getElementById('loading-overlay');
        const appContent = document.getElementById('app-content');
        const broadcastForm = document.getElementById('broadcast-form');
        const editModeDocId = document.getElementById('edit-mode-doc-id');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const formTitle = document.getElementById('form-title');
        const messagesList = document.getElementById('messages-list');
        const listStatus = document.getElementById('list-status');
        const targetClassesContainer = document.getElementById('target-classes-container');
        const classesLoadingPlaceholder = document.getElementById('classes-loading-placeholder');

        let isAuthReady = false;

        // --- 輔助函式 ---

        /**
         * 轉換 Firestore Timestamp 或 Date 物件為格式化字串
         * @param {object} timestamp - Firestore Timestamp 物件
         * @returns {string} 格式化日期時間字串
         */
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            // 嘗試使用 toDate() 轉換，如果不是 Timestamp，則直接使用
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const options = {
                year: 'numeric', month: 'numeric', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: false
            };
            return date.toLocaleString('zh-TW', options);
        }

        // --- 廣播對象 (班級列表) 處理 ---

        /**
         * 載入班級列表並渲染到表單中。
         */
        async function loadClassesAndRenderCheckboxes() {
            try {
                // 班級列表的公開路徑
                const classesCollectionPath = `/artifacts/${appId}/public/data/classes`;
                const q = query(collection(db, classesCollectionPath));

                // 班級列表使用 onSnapshot 確保即時更新 (雖然班級通常不會變動)
                onSnapshot(q, (snapshot) => {
                    if (classesLoadingPlaceholder) {
                         classesLoadingPlaceholder.classList.add('hidden');
                    }
                    if (targetClassesContainer) {
                        targetClassesContainer.innerHTML = ''; // 清空現有內容

                        if (snapshot.empty) {
                            targetClassesContainer.innerHTML = '<p class="text-center text-gray-500 col-span-3">找不到班級資料，請檢查 Firestore 路徑。</p>';
                            return;
                        }

                        snapshot.forEach((doc) => {
                            const classData = doc.data();
                            const classId = doc.id;
                            const classLabel = classData.name || classId; // 使用 name 欄位作為顯示名稱，沒有則用 ID

                            const checkboxDiv = document.createElement('div');
                            checkboxDiv.innerHTML = `
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" name="targetClasses" value="${classId}" class="h-4 w-4 text-primary-green border-gray-300 rounded focus:ring-primary-green">
                                    <span class="ml-2 text-gray-700">${classLabel}</span>
                                </label>
                            `;
                            targetClassesContainer.appendChild(checkboxDiv);
                        });
                        console.log(`[Firestore] 成功載入 ${snapshot.size} 個班級。`);
                    }
                }, (error) => {
                    console.error("[Firestore] 載入班級列表失敗: ", error);
                    if (classesLoadingPlaceholder) {
                        classesLoadingPlaceholder.classList.remove('hidden');
                        classesLoadingPlaceholder.innerHTML = '<p class="text-center text-red-500 col-span-3">載入班級資料失敗。請檢查權限設定。</p>';
                    }
                });

            } catch (e) {
                console.error("載入班級列表時發生錯誤: ", e);
                if (classesLoadingPlaceholder) {
                    classesLoadingPlaceholder.classList.remove('hidden');
                    classesLoadingPlaceholder.innerHTML = '<p class="text-center text-red-500 col-span-3">載入班級資料時發生致命錯誤。</p>';
                }
            }
        }

        // --- 訊息列表渲染與操作 ---

        /**
         * 渲染單一訊息卡片。
         * @param {string} id - 文件 ID
         * @param {object} msg - 訊息資料
         * @returns {string} HTML 字串
         */
        function renderMessageCard(id, msg) {
            const isEmergency = msg.isEmergency ? 'border-red-600 bg-red-50' : 'border-primary-green bg-green-50';
            const textColor = msg.isEmergency ? 'text-red-700' : 'text-primary-green';
            const classesText = msg.targetClasses && msg.targetClasses.length > 0 ? msg.targetClasses.join(', ') : '所有班級';
            const expiresText = formatTimestamp(msg.expiresAt);

            return `
                <div id="msg-${id}" class="card p-4 border-l-4 ${isEmergency}">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-gray-500">
                                單位: <span class="font-medium">${msg.unit}</span> | 
                                對象: <span class="font-medium">${classesText}</span> |
                                發佈時間: <span class="font-medium">${formatTimestamp(msg.createdAt)}</span>
                            </p>
                            <p class="mt-1 text-lg font-bold ${textColor}">${msg.content}</p>
                            <p class="mt-2 text-sm text-gray-600">過期時間: <span class="font-bold">${expiresText}</span></p>
                        </div>
                        <div class="flex space-x-2 flex-shrink-0">
                            <button type="button" onclick="handleEdit('${id}')" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                                編輯
                            </button>
                            <button type="button" onclick="handleDelete('${id}')" class="text-sm text-red-600 hover:text-red-800 font-medium">
                                刪除
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * 監聽訊息列表，即時渲染更新。
         */
        function setupMessagesListener() {
            // 訊息集合路徑
            const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
            const messagesRef = collection(db, messagesCollectionPath);
            
            // 查詢條件：僅顯示尚未過期的訊息 (expiresAt > 當前時間)
            const now = new Date();
            const q = query(
                messagesRef,
                where("expiresAt", ">", now)
                // orderBy("expiresAt", "asc") // 暫時移除 orderBy 以避免潛在的索引問題
            );

            onSnapshot(q, (snapshot) => {
                const messageHtml = [];
                if (snapshot.empty) {
                    listStatus.textContent = "目前沒有活躍的廣播訊息。";
                } else {
                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        messageHtml.push(renderMessageCard(doc.id, msg));
                    });
                    listStatus.classList.add('hidden');
                    messagesList.innerHTML = messageHtml.join('');
                    console.log(`[Firestore] 成功載入 ${snapshot.size} 則活躍訊息。`);
                }
            }, (error) => {
                console.error("[Firestore] 監聽訊息列表失敗: ", error);
                listStatus.textContent = "載入訊息列表失敗，請檢查網路連線或權限設定。";
                listStatus.classList.remove('hidden');
            });
        }

        // --- 編輯與刪除操作 (必須在 window 上註冊) ---
        
        /**
         * 處理編輯按鈕點擊事件，將資料載入到表單。
         * @param {string} id - 訊息文件 ID
         */
        window.handleEdit = async function(id) {
            const docRef = doc(db, `artifacts/${appId}/public/data/messages`, id);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const msg = docSnap.data();
                    editModeDocId.value = id;
                    formTitle.textContent = `編輯廣播訊息 (ID: ${id.substring(0, 8)}...)`;
                    document.querySelector('#unit-select').value = msg.unit;
                    document.querySelector('#message-content').value = msg.content;
                    document.querySelector('#is-emergency').checked = msg.isEmergency || false;

                    // Reset and check target classes
                    document.querySelectorAll('input[name="targetClasses"]').forEach(cb => cb.checked = false);
                    (msg.targetClasses || []).forEach(classId => {
                        const cb = document.querySelector(`input[value="${classId}"]`);
                        if(cb) cb.checked = true;
                    });
                    
                    // 根據持續時間設定 radio button (目前沒有 duration 欄位，先選預設 8 小時)
                    document.querySelector('input[name="duration"][value="8"]').checked = true;

                    cancelEditBtn.classList.remove('hidden');
                    window.scrollTo(0, 0); // 捲動到表單頂部
                } else {
                    console.warn(`找不到 ID 為 ${id} 的文件`);
                }
            } catch (error) {
                console.error("載入編輯資料失敗:", error);
            }
        }
        
        /**
         * 處理刪除按鈕點擊事件，直接從 Firestore 中永久刪除文件。
         * 這樣 onSnapshot 會自動觸發，讓訊息即時消失。
         * @param {string} id - 訊息文件 ID
         */
        window.handleDelete = async function(id) {
             // 使用自定義模態框取代 confirm()
            if (!document.getElementById('delete-modal')) {
                // 如果模態框不存在，創建它
                createDeleteModal(id);
            } else {
                // 如果模態框已存在，更新 ID
                const modal = document.getElementById('delete-modal');
                modal.dataset.deleteId = id;
                modal.classList.remove('hidden');
            }
        }
        
        /**
         * 建立並顯示自定義刪除確認模態框
         * @param {string} id - 訊息文件 ID
         */
        function createDeleteModal(id) {
            const modalHtml = `
                <div id="delete-modal" data-delete-id="${id}" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex justify-center items-center">
                    <div class="card p-6 w-11/12 md:w-1/3 mx-auto">
                        <h3 class="text-xl font-bold mb-4">確認刪除</h3>
                        <p class="mb-6">您確定要永久刪除這則廣播訊息嗎？刪除後將立即從廣播列表中消失。</p>
                        <div class="flex justify-end gap-3">
                            <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded" onclick="closeDeleteModal()">
                                取消
                            </button>
                            <button type="button" id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                                確定刪除
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
                const deleteId = document.getElementById('delete-modal').dataset.deleteId;
                closeDeleteModal();
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/messages`, deleteId));
                    console.log(`文件 ID: ${deleteId} 已成功刪除。`);
                } catch (error) {
                    console.error("刪除文件失敗:", error);
                }
            });
        }

        /**
         * 關閉自定義刪除確認模態框
         */
        window.closeDeleteModal = function() {
            const modal = document.getElementById('delete-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }


        /**
         * 重設表單狀態。
         */
        window.resetForm = function() {
            broadcastForm.reset();
            formTitle.textContent = '新增廣播訊息';
            // 重新檢查預設持續時間
            document.querySelector('input[name="duration"][value="8"]').checked = true;
            editModeDocId.value = '';
            cancelEditBtn.classList.add('hidden');
            // 確保所有班級選框都取消選取
            document.querySelectorAll('input[name="targetClasses"]').forEach(cb => cb.checked = false);
        }

        // --- 表單提交處理 ---

        broadcastForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const unit = document.querySelector('#unit-select').value;
            const content = document.querySelector('#message-content').value;
            const isEmergency = document.querySelector('#is-emergency').checked;
            const durationHours = parseInt(document.querySelector('input[name="duration"]:checked').value, 10);
            
            const selectedClasses = Array.from(document.querySelectorAll('input[name="targetClasses"]:checked'))
                                         .map(cb => cb.value);

            // 計算過期時間
            const expiresAt = new Date();
            expiresAt.setTime(expiresAt.getTime() + durationHours * 60 * 60 * 1000);

            const messageData = {
                unit: unit,
                content: content,
                isEmergency: isEmergency,
                targetClasses: selectedClasses,
                expiresAt: expiresAt,
                // createdAt 和 createdBy 只在新增時設定
            };

            const docId = editModeDocId.value;

            try {
                if (docId) {
                    // 編輯模式
                    const docRef = doc(db, `artifacts/${appId}/public/data/messages`, docId);
                    await updateDoc(docRef, messageData);
                    console.log("訊息更新成功:", docId);
                } else {
                    // 新增模式
                    const docRef = collection(db, `artifacts/${appId}/public/data/messages`);
                    await addDoc(docRef, {
                        ...messageData,
                        createdAt: serverTimestamp(),
                        createdBy: userId
                    });
                    console.log("訊息發佈成功");
                }
                
                // 無論新增或編輯成功，都重設表單
                resetForm();

            } catch (error) {
                console.error("發佈或更新訊息失敗:", error);
            }
        });


        // --- 啟動函式 ---

        /**
         * 應用程式啟動流程。
         */
        async function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 處理認證流程
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 監聽認證狀態變化
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log(`[Auth] 使用者已登入。UID: ${userId}`);
                        
                        if (!isAuthReady) {
                            isAuthReady = true;
                            // 認證就緒後才開始載入資料和設定監聽
                            loadClassesAndRenderCheckboxes(); // 修正點 1: 載入班級列表
                            setupMessagesListener();          // 監聽訊息列表

                            // 隱藏載入畫面，顯示應用程式內容
                            loadingOverlay.classList.add('hidden');
                            appContent.classList.remove('hidden');
                        }
                    } else {
                        // 認證失敗或登出，確保載入畫面消失
                        if (!isAuthReady) {
                             loadingOverlay.classList.add('hidden');
                             appContent.classList.remove('hidden');
                             listStatus.textContent = "認證失敗，請檢查權限設定。";
                             console.error("[Auth] 認證失敗或用戶已登出。");
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase 初始化失敗或認證錯誤:", error);
                // 無論如何，如果發生錯誤，也要移除載入畫面
                loadingOverlay.classList.add('hidden');
                appContent.classList.remove('hidden');
                document.getElementById('list-status').textContent = `系統啟動錯誤: ${error.message}`;
            }
        }

        // 啟動應用程式
        initializeAppAndAuth();

    </script>
</body>
</html>
