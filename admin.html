<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班級電子佈告欄</title>
    <style>
        /* CSS 樣式與之前版本相同 */
        :root {
            --board-bg: #013220; --card-bg: #02402c; --text-color: #ecf0f1;
            --title-color: #f1c40f; --link-color: #ffcc66; --border-color: #7f8c8d;
            --urgent-bg: #8B0000;
        }
        body, html { margin: 0; padding: 0; background-color: var(--board-bg); font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; color: var(--text-color); }
        #header { background-color: var(--board-bg); padding: 1rem 2rem; border-bottom: 2px solid var(--border-color); box-shadow: 0 4px 6px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        #class-title { margin: 0; font-size: 2rem; color: var(--title-color); }
        #clock { font-size: 1.8rem; color: var(--title-color); font-weight: bold; }
        #main-container { padding: 2rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 2rem; }
        .card { background-color: var(--card-bg); border: 2px solid var(--border-color); border-radius: 8px; box-shadow: 5px 5px 10px rgba(0,0,0,0.3); padding: 1.5rem; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; height: 180px; justify-content: space-between; position: relative; }
        .card.urgent { background-color: var(--urgent-bg); border-color: var(--title-color); }
        .card.read { opacity: 0.7; }
        .unread-indicator { position: absolute; top: 10px; left: 10px; width: 10px; height: 10px; background-color: var(--title-color); border-radius: 50%; display: block; }
        .card.read .unread-indicator { display: none; }
        .card:hover { transform: translateY(-5px); box-shadow: 8px 8px 15px rgba(0,0,0,0.4); }
        .card-main-content { font-size: 1.25rem; font-weight: bold; color: var(--title-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-department { font-size: 0.9rem; color: var(--text-color); margin: 1rem 0; }
        .card-footer { margin-top: auto; padding-top: 0.5rem; border-top: 1px solid var(--border-color); font-size: 0.8rem; color: #bdc3c7; text-align: right; }
        #modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
        #modal-content { background-color: var(--card-bg); margin: auto; padding: 3rem; border: 2px solid var(--border-color); border-radius: 8px; width: 80%; max-width: 800px; max-height: 80vh; overflow-y: auto; box-shadow: 0 0 20px rgba(0,0,0,0.5); position: relative; display: flex; flex-direction: column; }
        #modal-close { position: absolute; top: 1rem; right: 1.5rem; color: var(--text-color); font-size: 2.5rem; font-weight: bold; cursor: pointer; }
        .modal-message-content { font-size: 1.5rem; font-weight: bold; color: var(--title-color); line-height: 1.7; white-space: pre-wrap; word-wrap: break-word; flex-grow: 1; margin-bottom: 1.5rem; }
        .modal-message-content a { color: var(--link-color); text-decoration: underline; }
        .modal-department-footer { font-size: 1rem; color: var(--text-color); text-align: right; margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        #loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5rem; }
    </style>
</head>
<body>
    <header id="header">
        <h1 id="class-title"></h1>
        <div id="clock"></div>
    </header>
    <div id="loader">載入公告中...</div>
    <main id="main-container"></main>
    <div id="modal">
        <div id="modal-content">
            <span id="modal-close">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script type="module">
        // =================================================================
        // 最終修正：確保以下網址為純粹的字串，
        // 移除了所有會導致錯誤的 Markdown 格式。
        // =================================================================
        import { initializeApp } from "[https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js](https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js)";
        import { getFirestore, collection, query, where, orderBy, onSnapshot, getDocs } from "[https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js](https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js)";

        // Firebase 設定已為您填入
        const firebaseConfig = {
            apiKey: "AIzaSyDQCFgkOKJcz6dKP7gZMEjCYBJd3xnJ3bA",
            authDomain: "school-broadcast-system.firebaseapp.com",
            projectId: "school-broadcast-system",
            storageBucket: "school-broadcast-system.appspot.com",
            messagingSenderId: "1057938447303",
            appId: "1:1057938447303:web:81042cfb29f24bc4ff97e2",
            measurementId: "G-LLRPYTW9QX"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const container = document.getElementById('main-container');
        const loader = document.getElementById('loader');
        const modal = document.getElementById('modal');
        const modalBody = document.getElementById('modal-body');
        const closeModal = document.getElementById('modal-close');
        const clockElement = document.getElementById('clock');
        const classTitleElement = document.getElementById('class-title');
        
        // --- State Management ---
        const readMessageIds = new Set(); // << 新增：用來“記憶”已讀訊息的清單
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let isFirstLoad = true; // << 用來判断是否為首次載入

        // --- Functions ---
        
        function updateClock() {
            const now = new Date();
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            clockElement.textContent = `${now.getMonth() + 1}/${now.getDate()} (${weekdays[now.getDay()]}) ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        }
        
        function playNotificationSound() {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.5);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function listenToMessages(classCode) {
            const now = new Date();
            const q = query(
                collection(db, "messages"),
                where("expiresAt", ">", now),
                where("targetClasses", "array-contains-any", ["All", classCode]),
                orderBy("expiresAt", "desc")
            );

            onSnapshot(q, (snapshot) => {
                loader.style.display = 'none';
                
                let newMessagesFound = false;
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added" && !isFirstLoad) {
                        newMessagesFound = true;
                    }
                });

                if (newMessagesFound) {
                    playNotificationSound();
                }

                renderAllMessages(snapshot.docs);
                isFirstLoad = false;

            }, (error) => {
                console.error("讀取公告時發生錯誤: ", error);
                loader.style.display = 'none';
                container.innerHTML = `<p style="text-align: center;">讀取公告失敗: ${error.message}</p>`;
            });
        }
        
        function renderAllMessages(docs) {
            container.innerHTML = '';
            if (!docs || docs.length === 0) {
                container.innerHTML = '<p style="text-align: center; width: 100%; font-size: 1.2rem;">目前沒有公告</p>';
                return;
            }
            docs.forEach(doc => {
                const msg = { id: doc.id, ...doc.data() };
                const card = createMessageCard(msg);
                container.appendChild(card);
            });
        }
        
        function createMessageCard(msg) {
            const card = document.createElement('div');
            card.className = `card ${msg.isEmergency ? 'urgent' : ''}`;
            
            if (readMessageIds.has(msg.id)) {
                card.classList.add('read');
            }

            const createdAt = msg.createdAt ? msg.createdAt.toDate().toLocaleString('zh-TW') : 'N/A';
            const expiresAt = msg.expiresAt ? msg.expiresAt.toDate().toLocaleString('zh-TW') : 'N/A';
            
            card.innerHTML = `
                <div class="unread-indicator"></div>
                <div>
                    <div class="card-main-content" title="${escapeHTML(msg.content)}">${escapeHTML(msg.content)}</div>
                    <div class="card-department">${escapeHTML(msg.unit)}</div>
                </div>
                <div class="card-footer">
                    <div>發布: ${createdAt}</div>
                    <div>截止: ${expiresAt}</div>
                </div>
            `;
            
            card.addEventListener('click', () => {
                showModal(msg);
                card.classList.add('read');
                readMessageIds.add(msg.id);
            });
            return card;
        }

        function showModal(msg) {
            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            const contentWithLinks = escapeHTML(msg.content).replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
            modalBody.innerHTML = `
                <div class="modal-message-content">${contentWithLinks}</div>
                <div class="modal-department-footer">${escapeHTML(msg.unit)}</div>
            `;
            modal.style.display = 'flex';
        }
        
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'})[m]);
        }

        async function main() {
            updateClock();
            setInterval(updateClock, 1000);

            const params = new URLSearchParams(window.location.search);
            const classCode = params.get('class');

            if (!classCode) {
                loader.style.display = 'none';
                classTitleElement.textContent = "未指定班級";
                container.innerHTML = '<p style="text-align: center;">請在網址後方加上 `?class=您的班級代號` 來查看公告。</p>';
                return;
            }
            
            const q = query(collection(db, "class_map"), where("classId", "==", classCode));
            const querySnapshot = await getDocs(q);
            
            let className = '電子佈告欄';
            if (!querySnapshot.empty) {
                className = querySnapshot.docs[0].data().name;
            }
            classTitleElement.textContent = className;
            
            listenToMessages(classCode);
        }

        // --- Event Listeners ---
        closeModal.onclick = () => { modal.style.display = 'none'; }
        window.onclick = (event) => { if (event.target == modal) { modal.style.display = 'none'; } }
        document.body.addEventListener('click', () => {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }, { once: true });


        main();
    </script>
</body>
</html>
