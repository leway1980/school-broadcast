<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校園廣播系統 - 行政管理後台</title>
    <!-- 引入 Tailwind CSS 框架，用於快速樣式設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 引入 Inter 字體和基本樣式 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; }
        
        /* --- 版面配置 CSS 調整 (Grid Layout) --- */
        /* 主網格佈局，小螢幕下為單欄 */
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 1024px) { 
             /* 關鍵修改: 將版面改為 50/50 比例 (1fr 1fr) */
            .main-grid { grid-template-columns: 1fr 1fr; } 
        }
        
        /* 單位管理清單項目樣式 */
        .unit-item { display: flex; justify-content: space-between; align-items: center; }
        
        /* 廣播清單項目的間隔 */
        .message-list-item:not(:last-child) {
            border-bottom: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="p-4 lg:p-10">
    <!-- Header 標題和管理員資訊 -->
    <div class="mb-8 border-b pb-4">
        <h1 class="text-4xl font-extrabold text-gray-800">行政管理後台</h1>
        <!-- 您詢問要更改的地方在此！已將硬式編碼的名稱改為動態顯示區塊 -->
        <p id="admin-info-display" class="text-sm text-gray-500 mt-1">載入管理員資訊中...</p>
    </div>

    <main class="main-grid">
        <!-- 區塊 1: 廣播訊息發布與編輯 (左側/頂部) -->
        <section class="p-6 bg-white rounded-xl shadow-lg h-fit" id="broadcast-control-section">
            <h2 class="text-2xl font-bold text-gray-700 mb-6">發布與編輯廣播</h2>
            
            <!-- 訊息輸入表單 -->
            <form id="broadcast-form" class="space-y-4">
                <input type="hidden" id="edit-mode-doc-id" value="">
                
                <!-- 訊息內容 -->
                <div>
                    <label for="message-content" class="block text-sm font-medium text-gray-700">訊息內容 (必填)</label>
                    <textarea id="message-content" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" 
                        rows="4" placeholder="請輸入廣播內容，例如：今日午餐有餘，請各班導師派員至學務處領取。"></textarea>
                </div>

                <!-- 目標單位選擇 -->
                <div>
                    <span class="block text-sm font-medium text-gray-700 mb-2">廣播對象 (可複選)</span>
                    <div id="unit-checkbox-container" class="space-y-1">
                        <!-- 單位勾選框會由 JavaScript 動態生成 -->
                        <div class="text-gray-500 text-sm">載入單位清單中...</div>
                    </div>
                </div>

                <!-- 廣播時效性 (Duration) -->
                <div>
                    <span class="block text-sm font-medium text-gray-700 mb-2">廣播時效 (必選)</span>
                    <div class="mt-1 space-x-4 flex">
                        <label class="inline-flex items-center">
                            <input type="radio" name="duration" value="8" class="form-radio text-indigo-600" checked>
                            <span class="ml-2 text-gray-600">8 小時 (預設)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="duration" value="24" class="form-radio text-indigo-600">
                            <span class="ml-2 text-gray-600">24 小時</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="duration" value="48" class="form-radio text-indigo-600">
                            <span class="ml-2 text-gray-600">48 小時</span>
                        </label>
                    </div>
                </div>

                <!-- 單位編輯模式的取消按鈕 -->
                <button type="button" id="cancel-edit-btn" class="hidden w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                    取消編輯 / 發布新訊息
                </button>

                <!-- 提交按鈕 -->
                <button type="submit" id="submit-btn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    發布廣播
                </button>
            </form>
        </section>

        <!-- 區塊 2: 單位與廣播列表 (右側/底部) -->
        <section class="space-y-8">
            <!-- 廣播清單 (目前有效) -->
            <div class="p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">目前有效廣播清單</h2>
                <div id="message-list-container" class="divide-y divide-gray-200">
                    <!-- 廣播訊息清單會由 JavaScript 動態生成 -->
                    <p class="text-gray-500 py-3">載入訊息清單中...</p>
                </div>
            </div>

            <!-- 單位管理 -->
            <div class="p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">單位管理</h2>
                
                <!-- 新增單位表單 -->
                <form id="unit-form" class="flex space-x-2 mb-4">
                    <input type="text" id="new-unit-name" placeholder="輸入新單位名稱 (例如：高一)" required
                        class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border text-sm">
                    <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition duration-150 ease-in-out">
                        新增
                    </button>
                </form>

                <!-- 單位清單 -->
                <div id="unit-list-container" class="divide-y divide-gray-200">
                    <!-- 單位清單會由 JavaScript 動態生成 -->
                    <p class="text-gray-500 py-3 text-sm">載入單位清單中...</p>
                </div>
            </div>
        </section>
    </main>
    
    <!-- 訊息彈出視窗 (用於代替 alert) -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full">
            <h3 id="modal-title" class="text-lg font-bold mb-2 text-gray-800">訊息</h3>
            <p id="modal-body" class="text-sm text-gray-600 mb-4">這是一個訊息內容。</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="hidden py-2 px-4 border rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">取消</button>
                <button id="modal-confirm-btn" class="py-2 px-4 border border-transparent rounded-md text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">確定</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, where, addDoc, updateDoc, deleteDoc, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 1. Firebase 服務初始化
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // 確保配置不為空
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase Configuration is missing!");
            document.body.innerHTML = '<div class="text-center p-8 text-red-600">錯誤：Firebase 配置遺失，請檢查環境設定。</div>';
            return;
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug'); // 啟用 Firestore 偵錯日誌
        
        // 2. 身份驗證
        let userId = 'loading'; // 預設狀態

        try {
            if (typeof __initial_auth_token !== 'undefined') {
                await signInWithCustomToken(auth, __initial_auth_token);
                console.log("使用自定義 Token 登入成功。");
            } else {
                await signInAnonymously(auth);
                console.log("使用匿名身份登入。");
            }
        } catch (error) {
            console.error("Firebase 登入失敗:", error);
            // 可以在此處顯示錯誤訊息給用戶
        }

        userId = auth.currentUser?.uid || crypto.randomUUID();
        
        // ** ADDED: 更新管理員資訊顯示 (動態從登入資訊中獲取) **
        const user = auth.currentUser;
        const adminInfoEl = document.getElementById('admin-info-display');
        if (adminInfoEl && user) {
            // 假設 displayName 和 email 來自 auth token
            const displayName = user.displayName || '未設定名稱';
            const email = user.email || user.uid;

            if (user.isAnonymous) {
                adminInfoEl.textContent = `管理員：匿名用戶 (UID: ${user.uid})`;
            } else {
                 adminInfoEl.textContent = `管理員：${displayName} (${email})`;
            }
        }
        // ** END ADDED **
        
        // 3. 全局變數定義
        const MESSAGES_COLLECTION_PATH = `/artifacts/${appId}/public/data/messages`;
        const UNITS_COLLECTION_PATH = `/artifacts/${appId}/public/data/units`;

        // 表單元素
        const form = document.getElementById('broadcast-form');
        const contentInput = document.getElementById('message-content');
        const unitCheckboxContainer = document.getElementById('unit-checkbox-container');
        const messageListContainer = document.getElementById('message-list-container');
        const unitListContainer = document.getElementById('unit-list-container');
        const editModeDocId = document.getElementById('edit-mode-doc-id');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const submitBtn = document.getElementById('submit-btn');
        
        // 單位表單元素
        const unitForm = document.getElementById('unit-form');
        const newUnitNameInput = document.getElementById('new-unit-name');
        
        // 模態框元素
        const modal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');


        /**
         * 顯示自定義模態框 (取代 alert/confirm)
         * @param {string} title - 標題
         * @param {string} body - 內容
         * @param {boolean} isConfirm - 是否為確認模式 (顯示取消按鈕)
         * @returns {Promise<boolean>} - 如果是確認模式，返回 true/false
         */
        function showModal(title, body, isConfirm = false) {
            modalTitle.textContent = title;
            modalBody.textContent = body;
            
            modalCancelBtn.classList.toggle('hidden', !isConfirm);
            modalConfirmBtn.textContent = isConfirm ? '確定' : '關閉';
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            return new Promise(resolve => {
                const handleConfirm = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    resolve(true);
                    modalConfirmBtn.removeEventListener('click', handleConfirm);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                };
                
                const handleCancel = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    resolve(false);
                    modalConfirmBtn.removeEventListener('click', handleConfirm);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                };

                modalConfirmBtn.addEventListener('click', handleConfirm);
                modalCancelBtn.addEventListener('click', handleCancel);
                
                // 允許點擊背景關閉 (非確認模式)
                if (!isConfirm) {
                    modal.onclick = (e) => {
                        if (e.target === modal) {
                            handleConfirm();
                        }
                    };
                } else {
                    modal.onclick = null; // 確認模式禁用背景點擊
                }
            });
        }


        // 4. 資料庫監聽與操作

        let unitsCache = []; // 用於儲存單位列表，供廣播發布表單使用

        // A. 單位列表即時監聽與渲染
        const unitsQuery = collection(db, UNITS_COLLECTION_PATH);
        onSnapshot(unitsQuery, (snapshot) => {
            unitsCache = []; // 清空緩存
            let unitListHtml = '';
            let unitCheckboxesHtml = '';

            snapshot.forEach(doc => {
                const unit = doc.data();
                const id = doc.id;
                unitsCache.push({ id, ...unit });

                // 渲染單位管理清單
                unitListHtml += `
                    <div class="unit-item py-3 text-sm">
                        <span class="text-gray-700">${unit.name}</span>
                        <button onclick="handleDeleteUnit('${id}')" type="button" 
                            class="text-red-600 hover:text-red-900 ml-4 transition duration-150 ease-in-out">
                            刪除
                        </button>
                    </div>
                `;

                // 渲染廣播發布表單中的勾選框
                unitCheckboxesHtml += `
                    <label class="inline-flex items-center text-sm mr-4">
                        <input type="checkbox" name="units" value="${id}" class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                        <span class="ml-2 text-gray-600">${unit.name}</span>
                    </label>
                `;
            });

            unitListContainer.innerHTML = unitListHtml || '<p class="text-gray-500 py-3 text-sm">目前沒有任何單位。</p>';
            unitCheckboxContainer.innerHTML = unitCheckboxesHtml || '<p class="text-red-500 text-sm">請先新增單位才能發布廣播。</p>';
        });
        
        // 處理刪除單位
        window.handleDeleteUnit = async (id) => {
            const confirmed = await showModal('確認刪除', '確定要永久刪除這個單位嗎？所有相關的廣播訊息將不再發布給這個單位。', true);
            if (confirmed) {
                try {
                    await deleteDoc(doc(db, UNITS_COLLECTION_PATH, id));
                    showModal('成功', '單位已成功刪除。');
                } catch (e) {
                    console.error("Error removing document: ", e);
                    showModal('錯誤', '刪除單位失敗，請稍後再試。');
                }
            }
        };


        // B. 廣播訊息即時監聽與渲染
        const messagesQuery = query(
            collection(db, MESSAGES_COLLECTION_PATH),
            where("expiresAt", ">", new Date()), // 只顯示尚未過期的訊息
            // 注意: Firestore 不允許在沒有索引的情況下同時使用 where 和 orderBy，
            // 由於這裡的 where 是必要條件，我們將移除 orderBy，並在客戶端進行排序。
            // orderBy("createdAt", "desc") 
        );
        
        onSnapshot(messagesQuery, (snapshot) => {
            let messages = [];
            snapshot.forEach(doc => {
                messages.push({ id: doc.id, ...doc.data() });
            });

            // 在客戶端按建立時間排序 (最新的在最上面)
            messages.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

            let messageListHtml = '';
            
            if (messages.length === 0) {
                messageListHtml = '<p class="text-gray-500 py-3">目前沒有任何有效的廣播訊息。</p>';
            } else {
                messages.forEach(message => {
                    const expiryTime = message.expiresAt.toDate().toLocaleString('zh-Hant', { 
                        year: 'numeric', month: '2-digit', day: '2-digit', 
                        hour: '2-digit', minute: '2-digit', hour12: false 
                    });
                    
                    // 找出單位的名稱
                    const targetUnits = message.targetUnitIds.map(unitId => {
                        const unit = unitsCache.find(u => u.id === unitId);
                        return unit ? unit.name : '未知單位';
                    }).join(', ');

                    messageListHtml += `
                        <div class="message-list-item py-4">
                            <p class="text-sm font-semibold text-gray-800">${message.content}</p>
                            <p class="text-xs text-gray-500 mt-1">
                                <span class="font-medium">目標單位:</span> ${targetUnits}
                            </p>
                            <p class="text-xs text-gray-500">
                                <span class="font-medium">發布者:</span> ${message.author || '系統管理員'} | 
                                <span class="font-medium">有效期限:</span> ${expiryTime}
                            </p>
                            <div class="mt-2 space-x-2">
                                <button onclick="handleEdit('${message.id}')" type="button" 
                                    class="text-xs py-1 px-2 border rounded-md text-indigo-600 hover:bg-indigo-50 transition duration-150 ease-in-out">
                                    編輯
                                </button>
                                <button onclick="handleDelete('${message.id}')" type="button" 
                                    class="text-xs py-1 px-2 border rounded-md text-red-600 hover:bg-red-50 transition duration-150 ease-in-out">
                                    立即過期
                                </button>
                            </div>
                        </div>
                    `;
                });
            }

            messageListContainer.innerHTML = messageListHtml;
        });

        // 5. 事件處理器

        // 處理新增單位
        unitForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const unitName = newUnitNameInput.value.trim();
            if (!unitName) return;

            try {
                // 檢查是否已存在
                const q = query(collection(db, UNITS_COLLECTION_PATH), where("name", "==", unitName));
                const existingDocs = await getDocs(q);
                
                if (!existingDocs.empty) {
                    showModal('警告', `單位名稱「${unitName}」已存在，請勿重複新增。`);
                    return;
                }

                await addDoc(collection(db, UNITS_COLLECTION_PATH), {
                    name: unitName,
                    createdAt: new Date()
                });
                newUnitNameInput.value = '';
                showModal('成功', `單位「${unitName}」已成功新增。`);
            } catch (e) {
                console.error("Error adding document: ", e);
                showModal('錯誤', '新增單位失敗，請稍後再試。');
            }
        });
        
        // 處理發布/編輯廣播訊息
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const content = contentInput.value.trim();
            const docId = editModeDocId.value.trim();
            
            // 獲取選中的單位 IDs
            const selectedUnitCheckboxes = document.querySelectorAll('input[name="units"]:checked');
            const targetUnitIds = Array.from(selectedUnitCheckboxes).map(cb => cb.value);
            
            // 獲取時效性 (小時)
            const durationHours = parseInt(document.querySelector('input[name="duration"]:checked')?.value || '8', 10);
            
            if (!content) {
                showModal('警告', '請輸入廣播內容。');
                return;
            }
            
            if (targetUnitIds.length === 0) {
                showModal('警告', '請至少選擇一個廣播對象/單位。');
                return;
            }

            const expiresAt = new Date(Date.now() + durationHours * 60 * 60 * 1000);
            const author = auth.currentUser?.displayName || auth.currentUser?.email || '系統管理員';
            const messageData = {
                content: content,
                targetUnitIds: targetUnitIds,
                expiresAt: expiresAt,
                author: author
                // createdAt 和 updatedAt 處理
            };

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = (docId ? '儲存中...' : '發布中...');
                
                if (docId) {
                    // 編輯模式
                    // 不更新 createdAt
                    messageData.updatedAt = new Date();
                    await updateDoc(doc(db, MESSAGES_COLLECTION_PATH, docId), messageData);
                    showModal('成功', '廣播訊息已成功更新！');
                } else {
                    // 新增模式
                    messageData.createdAt = new Date();
                    messageData.updatedAt = new Date();
                    await addDoc(collection(db, MESSAGES_COLLECTION_PATH), messageData);
                    showModal('成功', '新的廣播訊息已成功發布！');
                }
                
                resetForm();
            } catch (e) {
                console.error("Error processing document: ", e);
                showModal('錯誤', `處理訊息失敗：${e.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '發布廣播';
            }
        });

        // 處理編輯按鈕點擊事件 (填充表單)
        window.handleEdit = async (id) => {
            const confirmed = await showModal('編輯確認', '您將進入編輯模式，編輯完成後將以新的過期時間重新發布。', true);
            if (confirmed) {
                const docRef = doc(db, MESSAGES_COLLECTION_PATH, id);
                const snapshot = await getDoc(docRef);

                if (!snapshot.exists()) {
                    showModal('錯誤', '找不到要編輯的訊息。');
                    return;
                }

                const data = snapshot.data();
                
                // 1. 填充內容和 ID
                contentInput.value = data.content;
                editModeDocId.value = id;
                submitBtn.textContent = '儲存並重新發布';
                
                // 2. 填充勾選框
                document.querySelectorAll('input[name="units"]').forEach(cb => {
                    cb.checked = data.targetUnitIds.includes(cb.value);
                });
                
                // 3. 根據剩餘時間計算並填充時效性 (可選，但讓編輯體驗更好)
                const diffTime = data.expiresAt.toDate().getTime() - Date.now();
                const diffHours = diffTime / (1000 * 60 * 60);

                let durationValue = '8'; 
                if (Math.abs(diffHours - 24) < 1) durationValue = '24'; 
                else if (Math.abs(diffHours - 48) < 1) durationValue = '48'; 
                
                const durationInput = document.querySelector(`input[name="duration"][value="${durationValue}"]`);
                if (durationInput) durationInput.checked = true;

                cancelEditBtn.classList.remove('hidden');
                window.scrollTo(0, 0); // 滾動到頂部方便編輯
            }
        }
        
        // 處理刪除按鈕點擊事件 (將 expiresAt 設為當前時間，使其立即過期)
        window.handleDelete = async (id) => {
            const confirmed = await showModal('確認過期', '確定要將此廣播設為立即過期並從列表中移除嗎？', true);
            if (confirmed) {
                try {
                    await updateDoc(doc(db, MESSAGES_COLLECTION_PATH, id), { expiresAt: new Date() });
                    showModal('成功', '訊息已標記為過期，將自動從列表中消失。');
                } catch (e) {
                    console.error("Error marking document as expired: ", e);
                    showModal('錯誤', '標記過期失敗，請稍後再試。');
                }
            }
        };
        
        // 重設表單狀態
        function resetForm() {
            document.getElementById('broadcast-form').reset();
            // 重設所有勾選框狀態
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            // 預設選擇 8 小時
            document.querySelector('input[name="duration"][value="8"]').checked = true; 
            editModeDocId.value = '';
            cancelEditBtn.classList.add('hidden');
            submitBtn.textContent = '發布廣播';
            
            // 重設單位選擇為...
        }
        
        // 處理取消編輯
        cancelEditBtn.addEventListener('click', () => {
            resetForm();
        });
        
    </script>
</body>
</html>
