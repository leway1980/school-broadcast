<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校園廣播系統 - 行政管理後台</title>
    <!-- 引入 Tailwind CSS 框架，用於快速樣式設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 引入 Inter 字體和基本樣式 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; }
        
        /* --- 版面配置 CSS 調整 (Grid Layout) --- */
        /* 主網格佈局，小螢幕下為單欄 */
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 1024px) { 
             /* 關鍵修改: 將版面改為 50/50 比例 (1fr 1fr) */
            .main-grid { grid-template-columns: 1fr 1fr; } 
        }
        
        /* 單位管理清單項目樣式 */
        .unit-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-radius: 0.25rem; }
        .unit-item:hover { background-color: #e9ecef; }
        .unit-item input { border: none; background: transparent; }
        .unit-item button { color: #dc3545; }
        
        /* 廣播對象 (班級) 依年段分組的行樣式 */
        .grade-row { border-bottom: 1px dashed #e5e7eb; padding: 8px 0; }
        .grade-row:last-child { border-bottom: none; }
        
        /* 班級項目樣式，用於單行簡潔顯示 */
        .class-item { display: flex; align-items: center; }

        /* 程式碼區塊 1: 新增訊息網格佈局 (唯一新增的 CSS) */
        /* 說明: 這是為了實現右側訊息列表 3 欄式佈局而新增的樣式。 */
        .messages-grid {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr)); /* 手機預設 1 欄 */
            gap: 1rem;
        }
        @media (min-width: 1024px) { /* 電腦版改為 3 欄 */
            .messages-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- 登入畫面容器 -->
    <div id="login-container" class="text-center p-8 bg-white rounded-lg shadow-xl max-w-md w-full">
        <h1 class="text-2xl font-bold mb-4">校園廣播系統</h1>
        <p class="text-gray-600 mb-6">請使用學校 G Suite 帳號登入</p>
        <button id="login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center mx-auto">
            <!-- Google 圖示 SVG -->
            <svg class="w-6 h-6 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.82l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
            使用 Google 帳號登入
        </button>
    </div>

    <!-- 主操作畫面容器 -->
    <div id="main-container" class="w-full max-w-7xl p-8 bg-white rounded-lg shadow-xl hidden">
        <!-- 頂部標題和登出按鈕 -->
        <div class="flex justify-between items-center mb-6 pb-4 border-b">
            <div>
                <h1 class="text-3xl font-bold">行政管理後台</h1>
                <p id="user-info" class="text-sm text-gray-500"></p>
            </div>
            <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">登出</button>
        </div>

        <!-- 權限不足提示 -->
        <div id="permission-denied" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
            <p class="font-bold">權限不足</p><p>您的帳號不在管理員名單中，無法執行此操作。</p>
        </div>

        <!-- 應用程式內容網格 (左側表單, 右側列表) -->
        <div id="app-content" class="main-grid hidden">
            <!-- 左欄: 廣播發布表單 (維持原樣) -->
            <form id="broadcast-form" class="space-y-6">
                <input type="hidden" id="edit-mode-doc-id">
                
                <!-- 發布單位與持續時間區塊 -->
                <div class="flex gap-4">
                    
                    <!-- 發布單位選擇 -->
                    <div class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm">
                        <label for="unit-select" class="block text-sm font-medium text-gray-700">發布單位</label>
                        <select id="unit-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md">
                            <option value="" disabled selected>請選擇單位</option>
                        </select>
                    </div>
                    
                    <!-- 持續時間選擇 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">持續時間</label>
                        <div class="mt-1 flex space-x-2 text-sm font-medium">
                             <input type="radio" id="dur_8h" name="duration" value="8" class="hidden peer" checked>
                             <label for="dur_8h" class="px-3 py-1 border border-gray-300 rounded-md cursor-pointer 
                                text-gray-700 hover:bg-gray-100 
                                peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">8小時</label>
                             
                             <input type="radio" id="dur_1d" name="duration" value="24" class="hidden peer">
                             <label for="dur_1d" class="px-3 py-1 border border-gray-300 rounded-md cursor-pointer 
                                text-gray-700 hover:bg-gray-100 
                                peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">1天</label>
                             
                             <input type="radio" id="dur_2d" name="duration" value="48" class="hidden peer">
                             <label for="dur_2d" class="px-3 py-1 border border-gray-300 rounded-md cursor-pointer 
                                text-gray-700 hover:bg-gray-100 
                                peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">2天</label>
                        </div>
                    </div>
                </div>
                
                <!-- 單位管理區塊 -->
                <details id="unit-management">
                    <summary class="cursor-pointer text-blue-600 hover:underline font-semibold">管理發布單位 ▾</summary>
                    <div class="p-4 border border-gray-300 rounded-lg mt-2 space-y-2">
                         <div id="unit-list" class="space-y-2">
                             <!-- 單位清單將由 JavaScript 渲染 -->
                         </div>
                         <div class="flex justify-between items-center pt-2 border-t mt-2">
                             <button type="button" id="add-unit-btn" class="text-sm text-green-600 hover:text-green-700">✚ 新增單位</button>
                             <button type="button" id="save-units-btn" class="text-sm text-white bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded shadow-sm">儲存所有變更</button>
                         </div>
                    </div>
                </details>
                
                <!-- 廣播對象 (班級選擇區塊) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">廣播對象</label>
                    <div id="class-checkbox-container" class="mt-2 p-4 border rounded-md max-h-96 overflow-y-auto space-y-1">
                        <!-- 班級清單將由 JavaScript 渲染並依年段分組 -->
                        <p class="text-center text-gray-400 mt-4">載入班級資料中...</p>
                    </div>
                </div>
                
                <!-- 訊息內容輸入框 -->
                <div>
                    <label for="message-content" class="block text-sm font-medium text-gray-700">訊息內容</label>
                    <textarea id="message-content" rows="5" class="mt-1 shadow-sm block w-full sm:text-sm border border-gray-300 rounded-md"></textarea>
                </div>
                
                <!-- 緊急訊息勾選框 -->
                <div class="flex items-center">
                    <input id="is-emergency" type="checkbox" class="h-4 w-4 text-red-600 border-gray-300 rounded">
                    <label for="is-emergency" class="ml-2 block text-sm text-gray-900">設為緊急訊息</label>
                </div>
                
                <!-- 提交與取消按鈕 -->
                <div class="flex gap-4">
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">發布/更新公告</button>
                    <button type="button" id="cancel-edit-btn" class="w-1/3 flex justify-center py-2 px-4 border rounded-md text-sm font-medium bg-gray-200 hover:bg-gray-300 hidden">取消編輯</button>
                </div>
            </form>

            <!-- 右欄: 即時訊息列表 (唯一修改顯示邏輯的區塊) -->
            <div id="message-list-container" class="border-l pl-6">
                 <h2 class="text-xl font-bold mb-4">即時訊息列表 (未過期)</h2>
                 <div id="message-list" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                     <!-- 訊息將由新的 renderMessages 函式渲染 -->
                 </div>
            </div>
        </div>
    </div>

    <!-- JavaScript 邏輯區塊 -->
    <script type="module">
        // 引入 Firebase 必要的模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp, query, writeBatch, updateDoc, onSnapshot, where, orderBy, setLogLevel } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // 設定 Firebase log level for debugging
        setLogLevel('debug');
        
        // Firebase 設定 (維持原樣)
        const firebaseConfig = {
            apiKey: "AIzaSyDQCFgkOKJcz6dKP7gZMEjCYBJd3xnJ3bA",
            authDomain: "school-broadcast-system.firebaseapp.com",
            projectId: "school-broadcast-system",
            storageBucket: "school-broadcast-system.appspot.com",
            messagingSenderId: "1057938447303",
            appId: "1:1057938447303:web:81042cfb29f24bc4ff97e2",
            measurementId: "G-LLRPYTW9QX"
        };

        // 初始化 Firebase 服務
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ 'hd': 'tcsh.hlc.edu.tw' }); // 限定學校網域
        
        // 獲取 DOM 元素
        const loginContainer = document.getElementById('login-container');
        const mainContainer = document.getElementById('main-container');
        const unitSelect = document.getElementById('unit-select');
        const unitList = document.getElementById('unit-list');
        const addUnitBtn = document.getElementById('add-unit-btn');
        const saveUnitsBtn = document.getElementById('save-units-btn');
        const classCheckboxContainer = document.getElementById('class-checkbox-container');
        const messageList = document.getElementById('message-list');
        const editModeDocId = document.getElementById('edit-mode-doc-id');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        
        let unitData = []; 
        let isAdmin = false;

        // --- 以下所有函式，除了 renderMessages 和相關的 Firestore 查詢外，皆維持原樣 ---

        onAuthStateChanged(auth, user => {
            const userInfo = document.getElementById('user-info');
            if (user && user.email.endsWith('@tcsh.hlc.edu.tw')) {
                loginContainer.classList.add('hidden');
                mainContainer.classList.remove('hidden');
                userInfo.textContent = `管理員：${user.displayName} (${user.email})`;
                checkAdminPermission(user.email);
            } else {
                mainContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
            }
        });

        async function checkAdminPermission(email) {
            const docRef = doc(db, "admins", email);
            const docSnap = await getDoc(docRef);
            const permissionDenied = document.getElementById('permission-denied');
            const appContent = document.getElementById('app-content');
            
            if (docSnap.exists()) {
                isAdmin = true; 
                appContent.classList.remove('hidden');
                permissionDenied.classList.add('hidden');
                loadInitialData(); 
            } else {
                isAdmin = false;
                appContent.classList.add('hidden');
                permissionDenied.classList.remove('hidden');
            }
        }
        
        function loadInitialData() {
            if (!isAdmin) return; 

            onSnapshot(collection(db, "units"), (snapshot) => {
                unitData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUnits();
            }, (error) => console.error("Error fetching units:", error));
            
            const classQuery = query(collection(db, "class_map"), orderBy("classId"));
            onSnapshot(classQuery, (snapshot) => {
                renderClassCheckboxes(snapshot.docs.map(doc => doc.data()));
            }, (error) => {
                console.error("[Class Map Error] 無法取得班級資料:", error);
                classCheckboxContainer.innerHTML = `<p class="text-center text-red-500 mt-4">載入班級資料失敗。</p>`;
            });

            // 程式碼區塊 2: Firestore 查詢修改
            // 說明: 為了在客戶端進行更複雜的分組排序，我們移除 Firestore 的 orderBy，只篩選未過期的訊息。
            const q = query(collection(db, "messages"), where("expiresAt", ">", new Date()));
            onSnapshot(q, (snapshot) => {
                renderMessages(snapshot.docs); // 呼叫新的 renderMessages 函式
            }, (error) => console.error("Error fetching messages:", error));
        }
        
        function renderUnits() {
            unitSelect.innerHTML = '<option value="" disabled selected>請選擇單位</option>';
            unitList.innerHTML = '';
            
            unitData.forEach(({ id, name }, index) => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                unitSelect.appendChild(option);
                
                if (index === 0) unitSelect.value = name;

                const item = document.createElement('div');
                item.className = 'unit-item';
                item.innerHTML = `<input type="text" value="${name}" data-id="${id}" class="flex-grow unit-input"><button data-id="${id}" class="remove-unit-btn">✖</button>`;
                unitList.appendChild(item);
            });
            document.querySelectorAll('.remove-unit-btn').forEach(btn => btn.addEventListener('click', () => btn.parentElement.remove()));
        }
        
        function renderClassCheckboxes(classes) {
             classCheckboxContainer.innerHTML = '';
             const grades = {}; 
             
             const allDiv = document.createElement('div');
             allDiv.className = 'grade-row flex items-center bg-gray-50 p-2 rounded-t-md';
             allDiv.innerHTML = `<div class="flex items-center font-bold w-full"><input id="class-All" name="targetClasses" value="All" type="checkbox" class="h-4 w-4 text-indigo-600 all-class-checkbox"><label for="class-All" class="ml-2">全校廣播 (All)</label></div>`;
             classCheckboxContainer.appendChild(allDiv);
             
             if (classes.length === 0) {
                 const tip = document.createElement('p');
                 tip.className = 'text-center text-gray-400 mt-4';
                 tip.textContent = '班級對應表 (class_map) 資料為空。';
                 classCheckboxContainer.appendChild(tip);
                 return;
             }
             
             classes.forEach(c => {
                 if (!c.name || !c.classId) return; 
                 let grade = '其他'; 
                 let className = c.name.trim(); 
                 const gradeMatches = c.name.match(/^(國[一二三]|高[一二三]|[\u4e00-\u9fa5]{2,3})/);
                 if (gradeMatches) {
                     grade = gradeMatches[0];
                     let remainingName = c.name.substring(grade.length).trim();
                     if (remainingName.startsWith('-')) remainingName = remainingName.substring(1).trim();
                     className = remainingName || grade; 
                 } else if (c.name.includes('-')) {
                     const parts = c.name.split('-');
                     grade = parts[0].trim();
                     className = parts.slice(1).join('-').trim();
                     if (!className) className = grade;
                 }
                 if (!className) return;
                 if (!grades[grade]) grades[grade] = { classes: [] };
                 grades[grade].classes.push({ id: c.classId, name: className });
             });
             
             for (const grade in grades) {
                const gradeInfo = grades[grade]; 
                const gradeContainer = document.createElement('div');
                gradeContainer.className = "grade-row flex items-start p-2";

                const classItemsHTML = gradeInfo.classes.map(c => {
                    const classId = c.id;
                    let className = c.name; 
                    let displayChar = '';  
                    let baseName = className; 
                    if (baseName.endsWith('班') || baseName.endsWith('組')) baseName = baseName.slice(0, -1); 
                    if (baseName === '大愛') displayChar = '愛'; 
                    else if (baseName.length > 0) displayChar = baseName.charAt(0); 
                    else displayChar = className.charAt(0) || '?';
                    return `<div class="class-item flex items-center"><input id="class-${classId}" name="targetClasses" value="${classId}" type="checkbox" class="h-4 w-4 text-indigo-600 class-checkbox" data-grade="${grade}"><label for="class-${classId}" class="ml-1 text-sm mr-2">${displayChar}</label></div>`;
                }).join('');

                gradeContainer.innerHTML = `<div class="flex items-center font-bold w-24 flex-shrink-0"><input id="grade-${grade}" type="checkbox" class="h-4 w-4 text-indigo-600 grade-checkbox" data-grade="${grade}"><label for="grade-${grade}" class="ml-2 text-gray-700">${grade}</label></div><div class="flex flex-wrap flex-1">${classItemsHTML}</div>`;
                classCheckboxContainer.appendChild(gradeContainer);
             }
             
             document.querySelectorAll('.grade-checkbox').forEach(cb => {
                 cb.addEventListener('change', (e) => {
                     const grade = e.target.dataset.grade;
                     document.querySelectorAll(`input.class-checkbox[data-grade="${grade}"]`).forEach(classCb => classCb.checked = e.target.checked);
                 });
             });
             
             document.querySelectorAll('input.class-checkbox').forEach(cb => {
                 cb.addEventListener('change', (e) => {
                     const grade = e.target.dataset.grade;
                     const gradeCheckbox = document.getElementById(`grade-${grade}`);
                     const totalClasses = document.querySelectorAll(`input.class-checkbox[data-grade="${grade}"]`).length;
                     const checkedClasses = document.querySelectorAll(`input.class-checkbox[data-grade="${grade}"]:checked`).length;
                     gradeCheckbox.checked = (totalClasses === checkedClasses);
                 });
             });

             document.getElementById('class-All').addEventListener('change', (e) => {
                 const isChecked = e.target.checked;
                 document.querySelectorAll('.grade-checkbox, input.class-checkbox').forEach(cb => cb.checked = isChecked);
             });
        }

        // 程式碼區塊 3: 渲染訊息列表函式 (唯一修改的核心邏輯)
        // 說明: 此函式被完全重寫，以實現「分組 -> 排序 -> 3 欄式網格」的渲染邏輯。
        function renderMessages(docs) {
            messageList.innerHTML = '';
            if (docs.length === 0) {
                messageList.innerHTML = `<p class="text-gray-500 text-center">沒有未過期的訊息。</p>`;
                return;
            }

            // 1. 將 Firestore 文件轉換為 JS 物件陣列
            const messages = docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // 2. 雙重排序：先依處室名稱，再依發布時間倒序 (最新在前)
            messages.sort((a, b) => {
                const unitComparison = a.unit.localeCompare(b.unit, 'zh-TW');
                if (unitComparison !== 0) return unitComparison;
                
                const timeA = a.createdAt ? a.createdAt.toDate().getTime() : 0;
                const timeB = b.createdAt ? b.createdAt.toDate().getTime() : 0;
                return timeB - timeA;
            });

            // 3. 依處室名稱將訊息分組
            const groupedMessages = messages.reduce((acc, message) => {
                const unit = message.unit;
                if (!acc[unit]) acc[unit] = [];
                acc[unit].push(message);
                return acc;
            }, {});

            // 4. 遍歷分組後的資料，渲染每個處室的區塊
            const sortedUnits = Object.keys(groupedMessages);
            sortedUnits.forEach(unit => {
                // 建立每個處室的容器
                const unitGroupContainer = document.createElement('div');
                unitGroupContainer.className = 'mb-6';

                // 建立處室標題
                const titleElement = document.createElement('h3');
                titleElement.className = 'text-lg font-bold text-gray-800 mb-3 pb-2 border-b';
                titleElement.textContent = `${unit} (${groupedMessages[unit].length})`;
                unitGroupContainer.appendChild(titleElement);

                // 建立 3 欄式網格容器
                const gridContainer = document.createElement('div');
                gridContainer.className = 'messages-grid';

                // 將該處室下的所有訊息卡片填入網格
                groupedMessages[unit].forEach(msg => {
                    gridContainer.innerHTML += createMessageCardHTML(msg);
                });

                unitGroupContainer.appendChild(gridContainer);
                messageList.appendChild(unitGroupContainer);
            });
            
            // 5. 為所有新生成的按鈕重新綁定事件
            document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', () => handleEdit(btn.dataset.id)));
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', () => handleDelete(btn.dataset.id)));
        }

        // 程式碼區塊 4: 訊息卡片 HTML 生成輔助函式 (新增)
        // 說明: 為了讓 renderMessages 函式更清晰，將卡片 HTML 的生成邏輯獨立出來。
        function createMessageCardHTML(msg) {
            let expiresDate = msg.expiresAt instanceof Date ? msg.expiresAt : msg.expiresAt.toDate();
            let timeLeft = Math.round((expiresDate - new Date()) / (1000 * 60 * 60));
            if (timeLeft < 0) timeLeft = 0; 

            return `
                <div class="p-4 border rounded-md h-full flex flex-col justify-between ${msg.isEmergency ? 'bg-red-50 border-red-200' : 'bg-white shadow-sm'}">
                    <div>
                        <div class="flex justify-between items-start">
                            <p class="font-bold text-gray-900">${msg.unit}</p>
                            <div class="flex gap-2 flex-shrink-0">
                                <button class="edit-btn text-sm text-blue-500 hover:underline" data-id="${msg.id}">編輯</button>
                                <button class="delete-btn text-sm text-red-500 hover:underline" data-id="${msg.id}">刪除</button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-700 mt-1 break-words">${msg.content}</p>
                    </div>
                    <div class="text-xs text-gray-500 mt-3 pt-2 border-t">
                        發布給: ${msg.targetClasses.join(', ')} <br>
                        ${msg.isEmergency ? '<span class="font-bold text-red-600">緊急</span> |' : ''} 剩餘: ${timeLeft} 小時
                    </div>
                </div>
            `;
        }
        
        // --- 以下所有函式皆維持原樣 ---

        async function saveUnitsChanges() {
            const batch = writeBatch(db);
            const newUnitElements = unitList.querySelectorAll('input');
            const currentUnitNames = new Set();
            let hasError = false;

            newUnitElements.forEach(input => {
                const name = input.value.trim();
                if (!name) { console.error("單位名稱不可為空！"); hasError = true; return; }
                if (currentUnitNames.has(name)) { console.error(`單位名稱 "${name}" 重複！`); hasError = true; return; }
                currentUnitNames.add(name);
                
                const id = input.dataset.id;
                if (id) batch.update(doc(db, "units", id), { name }); 
                else batch.set(doc(collection(db, "units")), { name }); 
            });

            if (hasError) return;

            const originalNames = new Set(unitData.map(u => u.name));
            originalNames.forEach(name => {
                if (!currentUnitNames.has(name)) {
                    const unitToDelete = unitData.find(u => u.name === name);
                    if (unitToDelete) batch.delete(doc(db, "units", unitToDelete.id));
                }
            });
            
            try { await batch.commit(); } 
            catch (e) { console.error("單位列表更新失敗:", e); }
        }

        document.getElementById('login-btn').addEventListener('click', () => signInWithPopup(auth, provider));
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        addUnitBtn.addEventListener('click', () => {
            const item = document.createElement('div');
            item.className = 'unit-item';
            item.innerHTML = `<input type="text" placeholder="新單位名稱" data-id="" class="flex-grow unit-input"><button class="remove-unit-btn">✖</button>`; 
            unitList.appendChild(item);
            item.querySelector('button').addEventListener('click', () => item.remove());
            item.querySelector('input').focus(); 
        });
        
        saveUnitsBtn.addEventListener('click', saveUnitsChanges);
        unitList.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
                e.preventDefault(); 
                saveUnitsChanges(); 
            }
        });

        document.getElementById('broadcast-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const unit = unitSelect.value;
            const content = document.getElementById('message-content').value;
            const isEmergency = document.getElementById('is-emergency').checked;
            const durationHours = parseInt(document.querySelector('input[name="duration"]:checked').value);
            const selectedClasses = Array.from(document.querySelectorAll('input[name="targetClasses"]:checked')).map(cb => cb.value);

            if (!unit || !content.trim() || selectedClasses.length === 0) {
                console.error('發布單位、訊息內容和廣播對象皆不可為空！'); return;
            }

            const messageData = {
                unit, content, isEmergency,
                targetClasses: selectedClasses,
                author: { name: auth.currentUser.displayName, email: auth.currentUser.email },
                createdAt: serverTimestamp(),
                expiresAt: new Date(Date.now() + durationHours * 60 * 60 * 1000) 
            };
            
            try {
                const docId = editModeDocId.value;
                if (docId) await updateDoc(doc(db, "messages", docId), messageData);
                else await addDoc(collection(db, "messages"), messageData);
                resetForm(); 
            } catch (error) { console.error(`操作失敗: ${error.message}`); }
        });

        cancelEditBtn.addEventListener('click', resetForm);
        
        async function handleEdit(id) {
            const docSnap = await getDoc(doc(db, "messages", id));
            if (docSnap.exists()) {
                const msg = docSnap.data();
                
                editModeDocId.value = id;
                document.querySelector('#unit-select').value = msg.unit;
                document.querySelector('#message-content').value = msg.content;
                document.querySelector('#is-emergency').checked = msg.isEmergency;
                
                document.querySelectorAll('input[name="targetClasses"], .grade-checkbox').forEach(cb => cb.checked = false);

                msg.targetClasses.forEach(classId => {
                    const cb = document.querySelector(`input[value="${classId}"]`);
                    if(cb) cb.checked = true;
                });
                
                document.querySelectorAll('.grade-checkbox').forEach(gradeCb => {
                    const grade = gradeCb.dataset.grade;
                    const classCbs = document.querySelectorAll(`input.class-checkbox[data-grade="${grade}"]`);
                    const totalClasses = classCbs.length;
                    const checkedClasses = Array.from(classCbs).filter(cb => cb.checked).length;
                    if (totalClasses > 0 && totalClasses === checkedClasses) gradeCb.checked = true;
                });

                // 處理持續時間
                const now = new Date();
                const expires = msg.expiresAt.toDate();
                const diffHours = (expires - now) / (1000 * 60 * 60);

                let durationValue = '8';
                if (diffHours > 20 && diffHours < 28) durationValue = '24';
                else if (diffHours > 44 && diffHours < 52) durationValue = '48';
                
                document.querySelector(`input[name="duration"][value="${durationValue}"]`).checked = true;

                cancelEditBtn.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' }); // 平滑滾動到頂部
            }
        }
        
        async function handleDelete(id) {
            // 由於不能使用 confirm，直接將訊息設為過期
            await updateDoc(doc(db, "messages", id), { expiresAt: new Date() });
            console.log("訊息已標記為過期。");
        }
        
        function resetForm() {
            document.getElementById('broadcast-form').reset();
            editModeDocId.value = '';
            cancelEditBtn.classList.add('hidden');
            // 重設持續時間
            document.getElementById('dur_8h').checked = true;
            // 重設廣播對象
            document.querySelectorAll('input[name="targetClasses"], .grade-checkbox').forEach(cb => cb.checked = false);
        }
    </script>
</body>
</html>

