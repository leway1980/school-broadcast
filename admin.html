<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校園廣播系統 - 行政後台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 基本樣式 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f0f2f5;
        }
        /* 優化 details 標籤的收合/展開箭頭 */
        summary {
            cursor: pointer;
            list-style: none; /* 移除預設的箭頭 */
        }
        summary::-webkit-details-marker {
            display: none; /* 移除 Chrome/Safari 的預設箭頭 */
        }
        /* 自訂收合/展開箭頭 */
        summary::before {
            content: '▶';
            margin-right: 8px;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }
        /* 隱藏滾動條但保留滾動功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- 左側：發布與管理 -->
        <div class="lg:col-span-2 space-y-8">
            <!-- 發布表單 -->
            <div class="bg-white p-6 rounded-2xl shadow-sm">
                <h1 class="text-2xl font-bold text-gray-800 mb-4">發布新廣播</h1>
                <form id="broadcast-form" class="space-y-4">
                    <input type="hidden" id="edit-mode-doc-id">
                    
                    <div>
                        <label for="unit-select" class="block text-sm font-medium text-gray-700 mb-1">發布單位</label>
                        <select id="unit-select" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <!-- 選項將由 JavaScript 動態載入 -->
                        </select>
                    </div>

                    <div>
                        <label for="message-content" class="block text-sm font-medium text-gray-700 mb-1">廣播內容 (可包含連結)</label>
                        <textarea id="message-content" rows="4" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required></textarea>
                    </div>

                    <!-- 廣播對象 (新版精簡介面) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">廣播對象</label>
                        <div id="class-targets-container" class="space-y-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                             <!-- 班級將由 JavaScript 動態載入 -->
                             <p class="text-gray-500">正在從資料庫載入班級列表中...</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                         <div class="flex items-center space-x-4">
                             <label class="flex items-center">
                                 <input type="checkbox" id="is-emergency" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                                 <span class="ml-2 text-sm font-medium text-red-600">緊急廣播 (將置頂)</span>
                             </label>
                             <div>
                                 <button type="button" id="select-all-btn" class="text-xs text-blue-600 hover:underline">全選</button> /
                                 <button type="button" id="deselect-all-btn" class="text-xs text-blue-600 hover:underline">全不選</button>
                             </div>
                         </div>
                    </div>
                    
                    <div class="flex items-center gap-4 pt-2">
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">發布廣播</button>
                        <button type="button" id="cancel-edit-btn" class="hidden w-full bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">取消編輯</button>
                    </div>
                </form>
            </div>
            
            <!-- 發布單位管理 (新功能) -->
            <div class="bg-white p-6 rounded-2xl shadow-sm">
                <details>
                    <summary class="text-xl font-bold text-gray-800">發布單位管理</summary>
                    <div class="mt-4 pt-4 border-t">
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-unit-name" placeholder="輸入新單位名稱" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <button id="add-unit-btn" class="bg-green-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-600 transition">新增</button>
                        </div>
                        <ul id="units-list" class="space-y-2">
                            <!-- 單位列表將由 JavaScript 動態載入 -->
                        </ul>
                    </div>
                </details>
            </div>
        </div>

        <!-- 右側：已公告內容 -->
        <div class="bg-white p-6 rounded-2xl shadow-sm">
            <h2 class="text-xl font-bold text-gray-800 mb-4">已公告內容 (最近 50 則)</h2>
            <div id="messages-list-container" class="h-[80vh] overflow-y-auto no-scrollbar">
                <ul id="messages-list" class="space-y-3">
                    <!-- 訊息將由 JavaScript 動態載入 -->
                    <li class="text-center text-gray-500 py-4">載入中...</li>
                </ul>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, serverTimestamp, doc, updateDoc, getDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase 設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyDQCFgkOKJcz6dKP7gZMEjCYBJd3xnJ3bA",
            authDomain: "school-broadcast-system.firebaseapp.com",
            projectId: "school-broadcast-system",
            storageBucket: "school-broadcast-system.appspot.com",
            messagingSenderId: "1057938447303",
            appId: "1:1057938447303:web:81042cfb29f24bc4ff97e2",
            measurementId: "G-LLRPYTW9QX"
        };
        
        // --- 初始化 Firebase ---
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            setLogLevel('debug'); // 開發時使用，可看到詳細日誌
            console.log("Firebase Initialized Successfully.");
        } catch (e) {
            console.error("Firebase 初始化失敗，請檢查 firebaseConfig 設定是否正確。", e);
            alert("Firebase 初始化失敗！請檢查主控台中的設定。");
        }

        // --- DOM 元素 ---
        const broadcastForm = document.querySelector('#broadcast-form');
        const unitSelect = document.querySelector('#unit-select');
        const messageContent = document.querySelector('#message-content');
        const isEmergency = document.querySelector('#is-emergency');
        const editModeDocId = document.querySelector('#edit-mode-doc-id');
        const cancelEditBtn = document.querySelector('#cancel-edit-btn');
        const messagesList = document.querySelector('#messages-list');
        const classTargetsContainer = document.querySelector('#class-targets-container');
        
        // 新增單位管理的 DOM 元素
        const addUnitBtn = document.querySelector('#add-unit-btn');
        const newUnitNameInput = document.querySelector('#new-unit-name');
        const unitsList = document.querySelector('#units-list');

        // --- 全域事件監聽 ---
        document.addEventListener('click', (e) => {
            if (e.target.matches('.edit-btn, .edit-btn *')) {
                const button = e.target.closest('.edit-btn');
                if (button) handleEdit(button.dataset.id);
            }
            if (e.target.matches('.delete-btn, .delete-btn *')) {
                 const button = e.target.closest('.delete-btn');
                if (button) handleDeleteMessage(button.dataset.id);
            }
            if (e.target.matches('#select-all-btn')) {
                document.querySelectorAll('input[name="targetClasses"]').forEach(cb => cb.checked = true);
            }
            if (e.target.matches('#deselect-all-btn')) {
                document.querySelectorAll('input[name="targetClasses"]').forEach(cb => cb.checked = false);
            }
        });

        // --- 核心功能函式 ---

        // 1. 渲染班級列表 (動態生成)
        function renderClasses(classes) {
            classTargetsContainer.innerHTML = '';
            // 按照年級分組
            const groupedByGrade = classes.reduce((acc, curr) => {
                (acc[curr.grade] = acc[curr.grade] || []).push(curr);
                return acc;
            }, {});

            // 按照 "國一", "國二", "國三", "高一", "高二", "高三" 的順序排序
            const gradeOrder = ["國一", "國二", "國三", "高一", "高二", "高三"];
            const sortedGrades = Object.entries(groupedByGrade).sort(([a], [b]) => gradeOrder.indexOf(a) - gradeOrder.indexOf(b));

            if (sortedGrades.length === 0) {
                 classTargetsContainer.innerHTML = '<p class="text-red-500">資料庫中找不到班級資料，請先新增。</p>';
                 return;
            }

            for (const [grade, classItems] of sortedGrades) {
                const gradeContainer = document.createElement('div');
                gradeContainer.className = 'flex items-center flex-wrap gap-x-3 gap-y-1';
                
                let gradeCheckboxes = `<label class="flex items-center font-semibold text-gray-800 whitespace-nowrap">
                    <input type="checkbox" class="grade-checkbox h-4 w-4 mr-2 rounded" data-grade="${grade}">
                    ${grade}
                </label>`;

                const classCheckboxes = classItems
                    .sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant')) // 班級排序
                    .map(c => `
                    <label class="flex items-center text-sm">
                        <input type="checkbox" name="targetClasses" value="${c.id}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 class-checkbox" data-grade="${grade}">
                        <span class="ml-1">${c.name}</span>
                    </label>
                `).join('');

                gradeContainer.innerHTML = gradeCheckboxes + classCheckboxes;
                classTargetsContainer.appendChild(gradeContainer);
            }
             // 年級全選功能
            document.querySelectorAll('.grade-checkbox').forEach(gcb => {
                gcb.addEventListener('change', (e) => {
                    const grade = e.target.dataset.grade;
                    document.querySelectorAll(`.class-checkbox[data-grade="${grade}"]`).forEach(ccb => {
                        ccb.checked = e.target.checked;
                    });
                });
            });
        }

        // 2. 渲染發布單位
        function renderUnits(units) {
             // 更新下拉選單
             unitSelect.innerHTML = units.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
             // 更新管理列表
             unitsList.innerHTML = units.map(u => `
                <li class="flex justify-between items-center p-2 bg-gray-100 rounded-md">
                    <span>${u.name}</span>
                    <button data-id="${u.id}" class="delete-unit-btn text-red-500 hover:text-red-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                    </button>
                </li>
             `).join('');
             
             // 為刪除按鈕加上事件監聽
             document.querySelectorAll('.delete-unit-btn').forEach(btn => {
                 btn.addEventListener('click', () => handleDeleteUnit(btn.dataset.id));
             });
        }

        // 3. 渲染已發布訊息
        function renderMessages(messages) {
            if (messages.length === 0) {
                messagesList.innerHTML = `<li class="text-center text-gray-500 py-4">目前沒有任何廣播。</li>`;
                return;
            }
            messagesList.innerHTML = messages.map(msg => {
                const isExpired = msg.expiresAt && msg.expiresAt.toDate() < new Date();
                const timestamp = msg.createdAt ? msg.createdAt.toDate().toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : 'N/A';
                return `
                    <li class="border rounded-lg p-3 transition-all ${isExpired ? 'bg-gray-100 opacity-60' : 'bg-white hover:shadow-md'}">
                        <div class="flex items-start justify-between">
                            <!-- 內容區 -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    ${msg.isEmergency ? '<span class="text-xs font-bold bg-red-100 text-red-700 px-2 py-0.5 rounded-full">緊急</span>' : ''}
                                    <p class="text-sm font-semibold text-gray-600 truncate">${msg.unit || '未分類'}</p>
                                    <span class="text-xs text-gray-400">${timestamp}</span>
                                </div>
                                <p class="text-gray-800 break-words whitespace-pre-wrap">${msg.content}</p>
                            </div>
                            <!-- 按鈕區 -->
                            <div class="flex items-center gap-2 ml-2 flex-shrink-0">
                                <button data-id="${msg.id}" class="edit-btn p-1.5 text-gray-500 hover:text-blue-600 rounded-full hover:bg-gray-100 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                </button>
                                <button data-id="${msg.id}" class="delete-btn p-1.5 text-gray-500 hover:text-red-600 rounded-full hover:bg-gray-100 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>
                    </li>
                `;
            }).join('');
        }

        // 4. 表單重置
        function resetForm() {
            broadcastForm.reset();
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            editModeDocId.value = '';
            cancelEditBtn.classList.add('hidden');
        }

        // --- Firestore 資料處理 ---

        // 新增或更新廣播
        broadcastForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const selectedClasses = Array.from(document.querySelectorAll('input[name="targetClasses"]:checked')).map(cb => cb.value);
            if (selectedClasses.length === 0) {
                alert("請至少選擇一個廣播對象班級。");
                return;
            }

            const now = new Date();
            const expires = new Date(now.getTime() + 8 * 60 * 60 * 1000); // 預設 8 小時後過期

            const messageData = {
                unit: unitSelect.value,
                content: messageContent.value,
                targetClasses: selectedClasses,
                isEmergency: isEmergency.checked,
                updatedAt: serverTimestamp(),
            };
            
            const id = editModeDocId.value;
            if (id) { // 編輯模式
                await updateDoc(doc(db, "messages", id), messageData);
                alert("廣播已更新。");
            } else { // 新增模式
                messageData.createdAt = serverTimestamp();
                messageData.expiresAt = expires; // 只有新增時設定過期時間
                await addDoc(collection(db, "messages"), messageData);
                alert("廣播已發布。");
            }
            resetForm();
        });

        // 處理編輯
        async function handleEdit(id) {
            const docRef = doc(db, "messages", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const msg = docSnap.data();
                editModeDocId.value = id;
                unitSelect.value = msg.unit;
                messageContent.value = msg.content;
                isEmergency.checked = msg.isEmergency;
                
                document.querySelectorAll('input[name="targetClasses"]').forEach(cb => cb.checked = false);
                msg.targetClasses.forEach(classId => {
                    const cb = document.querySelector(`input[value="${classId}"]`);
                    if (cb) cb.checked = true;
                });
                cancelEditBtn.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        // 刪除訊息 (軟刪除：設為立即過期)
        async function handleDeleteMessage(id) {
            if (confirm("確定要刪除（使此訊息立即過期）嗎？")) {
                await updateDoc(doc(db, "messages", id), { expiresAt: new Date() });
            }
        }

        // 新增單位
        addUnitBtn.addEventListener('click', async () => {
            const unitName = newUnitNameInput.value.trim();
            if (unitName) {
                try {
                    // 使用 unitName 作為文件 ID，避免重複
                    await setDoc(doc(db, "units", unitName), { name: unitName });
                    newUnitNameInput.value = '';
                } catch (error) {
                    console.error("新增單位失敗:", error);
                    alert("新增單位失敗，請稍後再試。");
                }
            }
        });

        // 刪除單位
        async function handleDeleteUnit(id) {
            if (confirm(`確定要刪除這個單位嗎？\n(注意：這不會影響已發布的訊息)`)) {
                try {
                    await deleteDoc(doc(db, "units", id));
                } catch (error) {
                    console.error("刪除單位失敗:", error);
                    alert("刪除單位失敗，請稍後再試。");
                }
            }
        }

        cancelEditBtn.addEventListener('click', resetForm);


        // --- 即時監聽 Firestore 變更 ---
        if (db) {
            // 監聽班級
            const classesQuery = query(collection(db, "classes"));
            onSnapshot(classesQuery, (snapshot) => {
                const classes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderClasses(classes);
            }, (error) => console.error("監聽班級列表失敗:", error));

            // 監聽單位
            const unitsQuery = query(collection(db, "units"), orderBy("name"));
            onSnapshot(unitsQuery, (snapshot) => {
                const units = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUnits(units);
            }, (error) => console.error("監聽單位列表失敗:", error));
            
            // 監聽訊息
            const messagesQuery = query(collection(db, "messages"), orderBy("createdAt", "desc"), limit(50));
            onSnapshot(messagesQuery, (snapshot) => {
                const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMessages(messages);
            }, (error) => console.error("監聽訊息列表失敗:", error));
        }

    </script>
</body>
</html>

