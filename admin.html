<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校園廣播系統 - 行政管理後台</title>
    <!-- 引入 Tailwind CSS 框架，用於快速樣式設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 引入 Inter 字體和基本樣式 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; }
        
        /* --- 版面配置 CSS 調整 (Grid Layout) --- */
        /* 主網格佈局，小螢幕下為單欄 */
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 1024px) { 
             /* 關鍵修改: 將版面改為 50/50 比例 (1fr 1fr) */
            .main-grid { grid-template-columns: 1fr 1fr; } 
        }
        
        /* 單位管理清單項目樣式 */
        .unit-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-radius: 0.25rem; }
        .unit-item:hover { background-color: #e9ecef; }
        .unit-item input { border: none; background: transparent; }
        .unit-item button { color: #dc3545; }
        
        /* 廣播對象 (班級) 依年段分組的行樣式 */
        .grade-row { border-bottom: 1px dashed #e5e7eb; padding: 8px 0; }
        .grade-row:last-child { border-bottom: none; }
        
        /* 班級項目樣式，用於單行簡潔顯示 */
        .class-item { display: flex; align-items: center; }

        /* 程式碼區塊 1: 新增訊息網格佈局 (唯一新增的 CSS) */
        .messages-grid {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr)); /* 手機預設 1 欄 */
            gap: 1rem;
        }
        @media (min-width: 1024px) { /* 電腦版改為 3 欄 */
            .messages-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- 登入畫面容器 -->
    <div id="login-container" class="text-center p-8 bg-white rounded-lg shadow-xl max-w-md w-full">
        <h1 class="text-2xl font-bold mb-4">校園廣播系統</h1>
        <p class="text-gray-600 mb-6">請使用學校 G Suite 帳號登入</p>
        <button id="login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center mx-auto">
            <!-- Google 圖示 SVG -->
            <svg class="w-6 h-6 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.82l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
            使用 Google 帳號登入
        </button>
    </div>

    <!-- 主操作畫面容器 -->
    <div id="main-container" class="w-full max-w-7xl p-8 bg-white rounded-lg shadow-xl hidden">
        
        <!-- 頂部標題和登出按鈕 -->
        <div class="flex justify-between items-center mb-6 pb-4 border-b">
            <div>
                <h1 class="text-3xl font-bold">行政管理後台</h1>
                <p id="user-info" class="text-sm text-gray-500"></p>
            </div>
            <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">登出</button>
        </div>

        <!-- 權限不足提示 -->
        <div id="permission-denied" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
            <p class="font-bold">權限不足</p><p>您的帳號不在管理員名單中，無法執行此操作。</p>
        </div>

        <!-- 應用程式內容網格 -->
        <div id="app-content" class="main-grid hidden">
            
            <!-- 左欄: 廣播發布表單 -->
            <form id="broadcast-form" class="space-y-6">
                <input type="hidden" id="edit-mode-doc-id">
                
                <div class="flex gap-4">
                    <!-- 
                    ============================================================
                    ▼▼▼ 程式碼修改區塊 1: 調整發布單位佈局 ▼▼▼
                    - 將 <label> 移至容器 <div> 外。
                    - 移除容器 <div> 的 p-3, border, rounded-lg, shadow-sm 樣式，使選單框變窄。
                    ============================================================
                    -->
                    <div class="flex-grow">
                        <label for="unit-select" class="block text-sm font-medium text-gray-700">發布單位</label>
                        <select id="unit-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="" disabled selected>請選擇單位</option>
                        </select>
                    </div>
                    <!-- ▲▲▲ 程式碼修改區塊 1 ▲▲▲ -->

                    <div class="p-3 border rounded-lg shadow-sm">
                        <label class="block text-sm font-medium text-gray-700">持續時間</label>
                        <div class="mt-2 flex items-center space-x-4">
                            <div class="relative">
                                <input type="radio" id="dur_8h" name="duration" value="8" class="hidden peer" checked>
                                <label for="dur_8h" class="px-3 py-1 border rounded-md cursor-pointer peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-500">8小時</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="dur_1d" name="duration" value="24" class="hidden peer">
                                <label for="dur_1d" class="px-3 py-1 border rounded-md cursor-pointer peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-500">1天</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="dur_2d" name="duration" value="48" class="hidden peer">
                                <label for="dur_2d" class="px-3 py-1 border rounded-md cursor-pointer peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-500">2天</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <details id="unit-management">
                    <summary class="cursor-pointer text-blue-600 hover:underline font-semibold">管理發布單位 ▾</summary>
                    <div class="p-4 border border-gray-300 rounded-lg mt-2 space-y-2">
                         <div id="unit-list" class="space-y-2"></div>
                         <div class="flex justify-between items-center pt-2 border-t mt-2">
                             <button type="button" id="add-unit-btn" class="text-sm text-green-600 hover:text-green-700">✚ 新增單位</button>
                             <button type="button" id="save-units-btn" class="text-sm text-white bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded shadow-sm">儲存所有變更</button>
                         </div>
                    </div>
                </details>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">廣播對象</label>
                    <div id="class-checkbox-container" class="mt-2 p-4 border rounded-md max-h-96 overflow-y-auto space-y-1">
                        <p class="text-center text-gray-400 mt-4">載入班級資料中...</p>
                    </div>
                </div>
                
                <div>
                    <label for="message-content" class="block text-sm font-medium text-gray-700">訊息內容</label>
                    <textarea id="message-content" rows="5" class="mt-1 shadow-sm block w-full sm:text-sm border border-gray-300 rounded-md"></textarea>
                </div>
                
                <div class="flex items-center">
                    <input id="is-emergency" type="checkbox" class="h-4 w-4 text-red-600 border-gray-300 rounded">
                    <label for="is-emergency" class="ml-2 block text-sm text-gray-900">設為緊急訊息</label>
                </div>
                
                <div class="flex gap-4">
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">發布/更新公告</button>
                    <button type="button" id="cancel-edit-btn" class="w-1/3 flex justify-center py-2 px-4 border rounded-md text-sm font-medium bg-gray-200 hover:bg-gray-300 hidden">取消編輯</button>
                </div>
            </form>

            <!-- 右欄: 即時訊息列表 -->
            <div id="message-list-container" class="border-l pl-6">
                 <h2 class="text-xl font-bold mb-4">即時訊息列表 (未過期)</h2>
                 <div id="message-list" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp, query, writeBatch, updateDoc, onSnapshot, where, orderBy, setLogLevel, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQCFgkOKJcz6dKP7gZMEjCYBJd3xnJ3bA",
            authDomain: "school-broadcast-system.firebaseapp.com",
            projectId: "school-broadcast-system",
            storageBucket: "school-broadcast-system.appspot.com",
            messagingSenderId: "1057938447303",
            appId: "1:1057938447303:web:81042cfb29f24bc4ff97e2",
            measurementId: "G-LLRPYTW9QX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ 'hd': 'tcsh.hlc.edu.tw' });

        const loginContainer = document.getElementById('login-container');
        const mainContainer = document.getElementById('main-container');
        const unitSelect = document.getElementById('unit-select');
        const unitList = document.getElementById('unit-list');
        const addUnitBtn = document.getElementById('add-unit-btn');
        const saveUnitsBtn = document.getElementById('save-units-btn');
        const classCheckboxContainer = document.getElementById('class-checkbox-container');
        const messageList = document.getElementById('message-list');
        const editModeDocId = document.getElementById('edit-mode-doc-id');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        
        let unitData = [];
        let isAdmin = false;
        
        // ============================================================
        // ▼▼▼ 程式碼修改區塊 2.1: 新增變數以儲存最後選擇的單位 ▼▼▼
        // ============================================================
        let lastSelectedUnit = ""; 
        // ▲▲▲ 程式碼修改區塊 2.1 ▲▲▲

        onAuthStateChanged(auth, user => {
            const userInfo = document.getElementById('user-info');
            if (user && user.email.endsWith('@tcsh.hlc.edu.tw')) {
                loginContainer.classList.add('hidden');
                mainContainer.classList.remove('hidden');
                userInfo.textContent = `管理員：${user.displayName} (${user.email})`;
                checkAdminPermission(user.email);
            } else {
                mainContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                userInfo.textContent = '';
                isAdmin = false;
            }
        });

        document.getElementById('login-btn').addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(error => console.error("登入失敗:", error));
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => {
             signOut(auth).catch(error => console.error("登出失敗:", error));
        });

        async function checkAdminPermission(email) {
            const docRef = doc(db, "admins", email);
            const docSnap = await getDoc(docRef);
            const permissionDenied = document.getElementById('permission-denied');
            const appContent = document.getElementById('app-content');
            if (docSnap.exists()) {
                isAdmin = true;
                appContent.classList.remove('hidden');
                permissionDenied.classList.add('hidden');
                loadInitialData();
            } else {
                isAdmin = false;
                appContent.classList.add('hidden');
                permissionDenied.classList.remove('hidden');
            }
        }

        function loadInitialData() {
            if (!isAdmin) return;
            const unitsQuery = query(collection(db, "units"), orderBy("name"));
            onSnapshot(unitsQuery, (snapshot) => {
                unitData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUnits();
            }, (error) => console.error("Error fetching units:", error));

            const classQuery = query(collection(db, "class_map"), orderBy("classId"));
            onSnapshot(classQuery, (snapshot) => {
                renderClassCheckboxes(snapshot.docs.map(doc => doc.data()));
            }, (error) => {
                console.error("[Class Map Error] 無法取得班級資料:", error);
                classCheckboxContainer.innerHTML = `<p class="text-center text-red-500 mt-4">載入班級資料失敗。</p>`;
            });

            const q = query(collection(db, "messages"), where("expiresAt", ">", new Date()), orderBy("expiresAt", "desc"));
            onSnapshot(q, (snapshot) => {
                renderMessages(snapshot.docs);
            }, (error) => console.error("Error fetching messages:", error));
        }

        function renderUnits() {
            unitSelect.innerHTML = '<option value="" disabled selected>請選擇單位</option>';
            unitList.innerHTML = '';
            unitData.forEach(({ id, name }) => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                unitSelect.appendChild(option);

                const item = document.createElement('div');
                item.className = 'unit-item';
                item.dataset.id = id;
                item.innerHTML = `
                    <input type="text" value="${name}" data-original-name="${name}" class="flex-grow p-1 border-b border-transparent focus:border-blue-500 focus:outline-none">
                    <button type="button" class="remove-unit-btn ml-2 px-2 py-1 text-red-500 hover:text-red-700">&times; 刪除</button>
                `;
                unitList.appendChild(item);
            });
            if (unitData.length > 0) {
                unitSelect.value = unitData[0].name;
            }
        }

        addUnitBtn.addEventListener('click', () => {
            const newItem = document.createElement('div');
            newItem.className = 'unit-item new-item';
            newItem.dataset.id = '';
            newItem.innerHTML = `
                <input type="text" value="新單位" placeholder="請輸入單位名稱" class="flex-grow p-1 border-b border-blue-500 focus:outline-none">
                <button type="button" class="remove-unit-btn ml-2 px-2 py-1 text-red-500 hover:text-red-700">&times; 刪除</button>
            `;
            unitList.appendChild(newItem);
            newItem.querySelector('input').focus();
        });

        saveUnitsBtn.addEventListener('click', async () => {
            const batch = writeBatch(db);
            const items = unitList.querySelectorAll('.unit-item');
            const namesToUpdate = new Set();
            let hasError = false;

            items.forEach(item => {
                const input = item.querySelector('input[type="text"]');
                const name = input.value.trim();
                const id = item.dataset.id;
                if (!name || namesToUpdate.has(name)) {
                    hasError = true; return;
                }
                namesToUpdate.add(name);
                if (id) {
                    if (name !== input.dataset.originalName) batch.update(doc(db, "units", id), { name });
                } else if (item.classList.contains('new-item')) {
                    batch.set(doc(collection(db, "units")), { name });
                }
            });

            if (hasError) return;

            const currentIds = Array.from(items).map(item => item.dataset.id).filter(Boolean);
            unitData.forEach(unit => {
                if (!currentIds.includes(unit.id)) batch.delete(doc(db, "units", unit.id));
            });
            await batch.commit();
        });

        unitList.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-unit-btn')) {
                e.target.closest('.unit-item')?.remove();
            }
        });

        function renderClassCheckboxes(classes) {
            classCheckboxContainer.innerHTML = '';
            const grouped = classes.reduce((acc, curr) => {
                (acc[curr.grade || '未分類'] = acc[curr.grade || '未分類'] || []).push(curr);
                return acc;
            }, {});

            const controls = document.createElement('div');
            controls.className = 'flex gap-4 mb-2 p-2 border-b';
            controls.innerHTML = `
                <button type="button" id="select-all-classes" class="text-sm text-blue-600 hover:underline">全選</button>
                <button type="button" id="deselect-all-classes" class="text-sm text-blue-600 hover:underline">全不選</button>
            `;
            classCheckboxContainer.appendChild(controls);

            Object.keys(grouped).sort().forEach(grade => {
                const gradeRow = document.createElement('div');
                gradeRow.className = 'grade-row';
                gradeRow.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <strong class="text-base font-semibold text-gray-800">年級: ${grade}</strong>
                        <button type="button" class="select-grade-btn text-xs text-indigo-500 hover:underline" data-grade="${grade}">此年級全選</button>
                    </div>`;
                const classGrid = document.createElement('div');
                classGrid.className = 'grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-x-4 gap-y-1';
                grouped[grade].forEach(cls => {
                    classGrid.innerHTML += `
                        <div class="class-item">
                            <input type="checkbox" id="class_${cls.classId}" name="classId" value="${cls.classId}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                            <label for="class_${cls.classId}" class="ml-2 text-sm text-gray-700">${cls.className || cls.classId}</label>
                        </div>`;
                });
                gradeRow.appendChild(classGrid);
                classCheckboxContainer.appendChild(gradeRow);
            });

            document.getElementById('select-all-classes').addEventListener('click', () => setAllCheckboxes(true));
            document.getElementById('deselect-all-classes').addEventListener('click', () => setAllCheckboxes(false));
            
            classCheckboxContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('select-grade-btn')) {
                    const gradeRow = e.target.closest('.grade-row');
                    gradeRow?.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
                }
            });
        }
        
        function setAllCheckboxes(checked) {
             document.querySelectorAll('#class-checkbox-container input[type="checkbox"]').forEach(cb => cb.checked = checked);
        }

        function renderMessages(docs) {
            messageList.innerHTML = docs.length === 0 ? '<p class="text-gray-500">目前沒有即時訊息。</p>' : '';
            docs.forEach(doc => {
                const msg = doc.data();
                const card = document.createElement('div');
                card.className = `p-4 rounded-lg border shadow-sm ${msg.isEmergency ? 'bg-red-50 border-red-200' : 'bg-white'}`;
                const expires = msg.expiresAt.toDate();
                const diffMs = expires - new Date();
                const diffHours = Math.floor(diffMs / 3600000);
                const diffMins = Math.floor((diffMs % 3600000) / 60000);
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="font-bold text-lg ${msg.isEmergency ? 'text-red-700' : 'text-gray-900'}">${msg.unit}</span>
                            ${msg.isEmergency ? '<span class="ml-2 text-xs font-semibold text-red-700 bg-red-200 px-2 py-0.5 rounded-full">緊急</span>' : ''}
                        </div>
                        <span class="text-xs text-gray-500">剩餘 ${diffHours} 小時 ${diffMins} 分鐘</span>
                    </div>
                    <p class="mt-2 text-gray-800 whitespace-pre-wrap">${msg.content}</p>
                    <p class="mt-2 text-xs text-gray-400">發布於: ${msg.createdAt.toDate().toLocaleString()}</p>
                    <p class="mt-1 text-xs text-gray-400">對象: ${msg.targetClasses.join(', ')}</p>
                    <div class="mt-3 flex gap-2">
                        <button type="button" class="edit-btn text-sm text-blue-600 hover:underline" data-id="${doc.id}">編輯</button>
                        <button type="button" class="delete-btn text-sm text-red-600 hover:underline" data-id="${doc.id}">刪除(設為過期)</button>
                    </div>`;
                messageList.appendChild(card);
            });
        }

        messageList.addEventListener('click', (e) => {
            const id = e.target.dataset.id;
            if (!id) return;
            if (e.target.classList.contains('edit-btn')) handleEdit(id);
            if (e.target.classList.contains('delete-btn')) handleDelete(id);
        });

        document.getElementById('broadcast-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAdmin) return;

            const unit = unitSelect.value;
            const content = document.getElementById('message-content').value.trim();
            const isEmergency = document.getElementById('is-emergency').checked;
            const durationHours = parseInt(document.querySelector('input[name="duration"]:checked').value, 10);
            const selectedClasses = Array.from(document.querySelectorAll('input[name="classId"]:checked')).map(cb => cb.value);

            if (!unit || selectedClasses.length === 0 || !content) {
                return;
            }

            const expiresAt = new Date(Date.now() + durationHours * 60 * 60 * 1000);
            const docId = editModeDocId.value;

            const data = { unit, content, isEmergency, targetClasses: selectedClasses, expiresAt, updatedAt: serverTimestamp() };

            if (docId) {
                await updateDoc(doc(db, "messages", docId), data);
            } else {
                data.createdAt = serverTimestamp();
                await addDoc(collection(db, "messages"), data);
            }
            
            // ============================================================
            // ▼▼▼ 程式碼修改區塊 2.2: 儲存成功發布的單位 ▼▼▼
            // ============================================================
            lastSelectedUnit = unit;
            // ▲▲▲ 程式碼修改區塊 2.2 ▲▲▲

            resetForm();
        });

        cancelEditBtn.addEventListener('click', resetForm);

        async function handleEdit(id) {
            const docRef = doc(db, "messages", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const msg = docSnap.data();
                unitSelect.value = msg.unit;
                document.getElementById('message-content').value = msg.content;
                document.getElementById('is-emergency').checked = msg.isEmergency;
                editModeDocId.value = id;
                document.querySelectorAll('input[name="classId"]').forEach(cb => cb.checked = msg.targetClasses.includes(cb.value));

                const diffHours = (msg.expiresAt.toDate() - msg.createdAt.toDate()) / 3600000;
                let durationValue = '8';
                if (Math.abs(diffHours - 24) < 1) durationValue = '24'; 
                else if (Math.abs(diffHours - 48) < 1) durationValue = '48'; 
                
                const durationInput = document.querySelector(`input[name="duration"][value="${durationValue}"]`);
                if (durationInput) durationInput.checked = true;

                cancelEditBtn.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        async function handleDelete(id) {
            await updateDoc(doc(db, "messages", id), { expiresAt: new Date() });
        }
        
        function resetForm() {
            document.getElementById('broadcast-form').reset();
            editModeDocId.value = '';
            cancelEditBtn.classList.add('hidden');
            
            // ============================================================
            // ▼▼▼ 程式碼修改區塊 2.3: 重設表單時，還原上次的單位選項 ▼▼▼
            // ============================================================
            if (lastSelectedUnit) {
                unitSelect.value = lastSelectedUnit;
            } else if (unitData.length > 0) {
                // 如果還沒有發布過，就退回預設 (第一個)
                unitSelect.value = unitData[0].name;
            }
            // ▲▲▲ 程式碼修改區塊 2.3 ▲▲▲
        }
    </script>
</body>
</html>
